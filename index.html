<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S≈™TA</title>
    <!-- Fonts: Outfit for Modern Look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tom Select -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <!-- Pako (GZIP Decompression) -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        primary: '#ff385c', // Airbnb Red-ish
                        secondary: '#222222', // Airbnb Dark
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Outfit', sans-serif; }
        [data-theme="light"] body { background-color: #f7f7f7; }
        [data-theme="dark"] body { background-color: #0f0f1a; }
        
        /* Dark mode overrides for cards and containers */
        [data-theme="dark"] .card { background-color: #1a1a2e !important; border-color: #2d2d44 !important; }
        [data-theme="dark"] .bg-base-100 { background-color: #1a1a2e !important; }
        [data-theme="dark"] .bg-gray-50 { background-color: #16162a !important; }
        [data-theme="dark"] .bg-gray-100 { background-color: #1f1f35 !important; }
        [data-theme="dark"] .border-gray-100 { border-color: #2d2d44 !important; }
        [data-theme="dark"] .border-gray-200 { border-color: #3d3d55 !important; }
        
        /* Dark mode text colors */
        [data-theme="dark"] .text-gray-400 { color: #9ca3af !important; }
        [data-theme="dark"] .text-gray-500 { color: #9ca3af !important; }
        [data-theme="dark"] .text-gray-600 { color: #d1d5db !important; }
        [data-theme="dark"] .text-gray-700 { color: #e5e7eb !important; }
        [data-theme="dark"] .text-gray-800 { color: #f3f4f6 !important; }
        [data-theme="dark"] .text-secondary { color: #e5e7eb !important; }
        
        /* Dark mode inputs */
        [data-theme="dark"] .input { background-color: #0f0f1a !important; border-color: #3d3d55 !important; color: #e5e7eb !important; }
        [data-theme="dark"] .input:focus { border-color: #ff385c !important; }
        [data-theme="dark"] .select { background-color: #0f0f1a !important; border-color: #3d3d55 !important; color: #e5e7eb !important; }
        
        /* Dark mode navbar */
        [data-theme="dark"] nav { background-color: #1a1a2e !important; border-color: #2d2d44 !important; }
        
        /* Dark mode tables */
        [data-theme="dark"] .table { color: #e5e7eb; }
        [data-theme="dark"] .table tr { border-color: #2d2d44 !important; }
        [data-theme="dark"] .table th { background-color: #16162a !important; color: #9ca3af !important; }
        [data-theme="dark"] .table-zebra tbody tr:nth-child(even) { background-color: #16162a !important; }
        [data-theme="dark"] .table tr:hover, [data-theme="dark"] .hover\\:bg-gray-50:hover { background-color: #232340 !important; }
        
        /* Dark mode badges and buttons */
        [data-theme="dark"] .badge { border-color: #3d3d55 !important; }
        [data-theme="dark"] .btn-ghost { color: #e5e7eb !important; }
        [data-theme="dark"] .btn-ghost:hover { background-color: #2d2d44 !important; }
        [data-theme="dark"] .btn-outline { border-color: #3d3d55 !important; color: #e5e7eb !important; }
        
        /* Dark mode tabs */
        [data-theme="dark"] .tabs-boxed { background-color: #16162a !important; }
        [data-theme="dark"] .tab { color: #9ca3af !important; }
        [data-theme="dark"] .tab-active { background-color: #2d2d44 !important; color: #fff !important; }
        
        /* Dark mode dropdown */
        [data-theme="dark"] .dropdown-content { background-color: #1a1a2e !important; border-color: #2d2d44 !important; }
        [data-theme="dark"] .dropdown-content li:hover { background-color: #232340 !important; }
        
        /* Dark mode collapse/accordion */
        [data-theme="dark"] .collapse { background-color: #16162a !important; border-color: #2d2d44 !important; }
        [data-theme="dark"] .collapse-title { color: #9ca3af !important; }
        
        /* Dark mode divider */
        [data-theme="dark"] .divider:before, [data-theme="dark"] .divider:after { background-color: #2d2d44 !important; }
        
        /* Dark mode chart elements */
        [data-theme="dark"] .chart-grid { background: #2d2d44; border-color: #3d3d55; }
        [data-theme="dark"] .chart-cell { background: #1a1a2e; }
        [data-theme="dark"] .chart-center { background: #0f0f1a; }
        [data-theme="dark"] .rashi-label { color: #9ca3af; }
        [data-theme="dark"] .house-label { color: #ff6b8a; }
        [data-theme="dark"] .planet-glyph { background: rgba(0,0,0,0.6); }
        
        /* Dark mode legend */
        [data-theme="dark"] .legend-swatch { border-color: rgba(255,255,255,0.2) !important; }
        
        /* Rashi colors in dark mode - slightly muted */
        [data-theme="dark"] .rashi-sun { background: linear-gradient(135deg, #78350f 0%, #451a03 100%); }
        [data-theme="dark"] .rashi-moon { background: linear-gradient(135deg, #374151 0%, #1f2937 100%); }
        [data-theme="dark"] .rashi-mars { background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%); }
        [data-theme="dark"] .rashi-mercury { background: linear-gradient(135deg, #064e3b 0%, #022c22 100%); }
        [data-theme="dark"] .rashi-jupiter { background: linear-gradient(135deg, #713f12 0%, #422006 100%); }
        [data-theme="dark"] .rashi-venus { background: linear-gradient(135deg, #581c87 0%, #3b0764 100%); }
        [data-theme="dark"] .rashi-saturn { background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%); }
        .chart-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 70px); gap: 0; border: 1px solid #e2e8f0; width: 100%; aspect-ratio: 1; border-radius: 8px; overflow: hidden; }
        .chart-cell { background: white; position: relative; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; font-size: 0.70rem; padding: 2px; transition: all 0.2s; }
        .chart-cell:hover { filter: brightness(0.95); }
        .chart-center { grid-column: 2 / span 2; grid-row: 2 / span 2; background: #fdfdfd; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .planet-glyph { font-weight: 600; margin: 1px; padding: 2px 4px; border-radius: 4px; font-size: 0.7rem; background: rgba(255,255,255,0.85); }
        .planet-Ascendant { color: #ff385c; background: rgba(255,241,242,0.95); }
        .planet-Sun { color: #f59e0b; } /* Bright Amber */
        .planet-Moon { color: #0ea5e9; } /* Sky Blue */
        .planet-Mars { color: #dc2626; } /* Red */
        .planet-Mercury { color: #22c55e; } /* Green */
        .planet-Jupiter { color: #ca8a04; } /* Dark Yellow - distinct from Sun */
        .planet-Venus { color: #ec4899; } /* Pink */
        .planet-Saturn { color: #6366f1; } /* Indigo */
        .planet-Rahu { color: #8b5cf6; } /* Purple */
        .planet-Ketu { color: #a855f7; } /* Light Purple */
        
        /* Dark mode planet colors - brighter for visibility */
        [data-theme="dark"] .planet-Sun { color: #fbbf24; }
        [data-theme="dark"] .planet-Moon { color: #38bdf8; }
        [data-theme="dark"] .planet-Mars { color: #f87171; }
        [data-theme="dark"] .planet-Mercury { color: #4ade80; }
        [data-theme="dark"] .planet-Jupiter { color: #facc15; }
        [data-theme="dark"] .planet-Venus { color: #f472b6; }
        [data-theme="dark"] .planet-Saturn { color: #818cf8; }
        [data-theme="dark"] .planet-Rahu { color: #a78bfa; }
        [data-theme="dark"] .planet-Ketu { color: #c084fc; }
        [data-theme="dark"] .planet-Ascendant { background: rgba(255,56,92,0.2); }
        
        /* Rashi Lord Color Backgrounds */
        .rashi-sun { background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); } /* Orange tint for Leo */
        .rashi-moon { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); } /* Silver for Cancer */
        .rashi-mars { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); } /* Red tint for Aries, Scorpio */
        .rashi-mercury { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); } /* Green for Gemini, Virgo */
        .rashi-jupiter { background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); } /* Yellow for Sagittarius, Pisces */
        .rashi-venus { background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); } /* Pink for Taurus, Libra */
        .rashi-saturn { background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%); } /* Blue tint for Capricorn, Aquarius */
        
        .rashi-label { position: absolute; bottom: 1px; right: 3px; font-size: 7px; font-weight: 600; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.02em; }
        .house-label { position: absolute; top: 1px; left: 3px; font-size: 8px; font-weight: 700; color: #ff385c; }
        
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 50; display: flex; justify-content: center; align-items: center; }
        #loader.hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        
        /* Custom Scrollbar for tables */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Input Transitions */
        .input-group:focus-within label { color: #ff385c; }

        /* Input Transitions */
        .input-group:focus-within label { color: #ff385c; }
        
        /* Legend Styling */
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 10px; }
        .legend-swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); }
        
        /* Mobile tab content: hidden by default on mobile, always visible on desktop */
        @media (max-width: 1023px) {
            .mobile-tab-content { display: none !important; }
            .mobile-tab-content.active { display: block !important; }
        }
        @media (min-width: 1024px) {
            .mobile-tab-content { display: block !important; }
        }
        
        /* Dasha expansion arrow transition */
        .dasha-arrow { transition: transform 0.2s ease; }
        
        /* ====== EVENT CALENDAR STYLES ====== */
        
        /* Event Type Pills */
        .event-pill { 
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            padding: 8px 14px; 
            border-radius: 24px; 
            border: 2px solid #e5e7eb; 
            background: white; 
            font-size: 13px; 
            font-weight: 500;
            cursor: pointer; 
            transition: all 0.2s ease;
            user-select: none;
        }
        .event-pill:hover { border-color: #ff385c; transform: translateY(-1px); }
        .event-pill.active { 
            background: linear-gradient(135deg, #ff385c 0%, #ff6b8a 100%); 
            border-color: #ff385c; 
            color: white; 
            box-shadow: 0 4px 12px rgba(255, 56, 92, 0.3);
        }
        .event-pill .pill-icon { font-size: 16px; }
        
        [data-theme="dark"] .event-pill { background: #1a1a2e; border-color: #3d3d55; color: #e5e7eb; }
        [data-theme="dark"] .event-pill:hover { border-color: #ff6b8a; }
        [data-theme="dark"] .event-pill.active { background: linear-gradient(135deg, #ff385c 0%, #ff6b8a 100%); color: white; }
        
        /* Calendar CSS */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        
        .calendar-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-base-content);
            opacity: 0.7;
            padding: 0.5rem 0;
        }
        
        .calendar-cell {
            aspect-ratio: 1;
            border-radius: 0.5rem;
            padding: 0.25rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
         
        /* Mobile List View for Calendar */
        @media (max-width: 640px) {
            .calendar-container {
                padding: 0.5rem;
            }
            
            .calendar-grid {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .calendar-header {
                display: none; /* Hide Sun, Mon... headers on mobile */
            }
            
            .calendar-cell {
                aspect-ratio: auto; /* Remove square aspect ratio */
                flex-direction: row; /* Horizontal layout */
                justify-content: space-between;
                align-items: center;
                padding: 1rem;
                background-color: var(--color-base-200); /* Card look */
                border: 1px solid var(--color-base-300);
            }
            
            .calendar-cell.empty {
                display: none; /* Hide empty filler cells */
            }
            
            .day-num {
                font-size: 1.1rem;
                font-weight: 700;
                display: flex;
                flex-direction: column;
            }
            
            .day-name-mobile {
                font-size: 0.75rem;
                font-weight: normal;
                opacity: 0.7;
                display: block !important;
            }

            .score-badge {
                font-size: 0.9rem !important;
                padding: 0.25rem 0.75rem !important;
            }
        }
        
        .day-name-mobile {
            display: none; /* Hidden on desktop */
        }
        
        .calendar-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .day-num {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .score-badge {
            font-size: 0.7rem;
            padding: 0.1rem 0.3rem;
            border-radius: 9999px;
            color: white;
            font-weight: 700;
            margin-top: 0.25rem;
        }
        
        /* Probability Colors */
        .prob-high { background-color: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.3); }
        .prob-high .score-badge { background-color: #16a34a; }
        
        .prob-medium { background-color: rgba(234, 179, 8, 0.15); border-color: rgba(234, 179, 8, 0.3); }
        .prob-medium .score-badge { background-color: #ca8a04; }
        
        .prob-low { background-color: rgba(249, 115, 22, 0.15); border-color: rgba(249, 115, 22, 0.3); }
        .prob-low .score-badge { background-color: #ea580c; }
        
        .prob-very-low { background-color: rgba(100, 116, 139, 0.1); border-color: rgba(100, 116, 139, 0.2); }
        .prob-very-low .score-badge { display: none; } /* Hide score 0 */

        /* Contributors List in Modal */
        .contributor-item {
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--color-base-200);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .contributor-level {
            text-transform: capitalize;
            font-weight: 600;
            color: var(--color-primary);
        }
        
        [data-theme="dark"] .prob-high { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); color: #fecaca; border-color: #b91c1c; }
        [data-theme="dark"] .prob-medium { background: linear-gradient(135deg, #78350f 0%, #92400e 100%); color: #fde68a; border-color: #b45309; }
        [data-theme="dark"] .prob-low { background: linear-gradient(135deg, #064e3b 0%, #065f46 100%); color: #a7f3d0; border-color: #059669; }
        [data-theme="dark"] .prob-very-low { background: #1f1f35; color: #9ca3af; }
        
        /* Month Navigation */
        .month-nav { display: flex; align-items: center; justify-content: space-between; }
        .month-nav .month-title { font-size: 1.25rem; font-weight: 700; }
        
        /* Day Modal */
        .day-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; }
        .day-modal-backdrop.active { opacity: 1; pointer-events: auto; }
        .day-modal { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25); transform: scale(0.9); transition: transform 0.2s ease; }
        .day-modal-backdrop.active .day-modal { transform: scale(1); }
        [data-theme="dark"] .day-modal { background: #1a1a2e; }
    </style>
</head>
<body class="text-secondary antialiased min-h-screen flex flex-col">

    <!-- LOADER -->
    <div id="loader">
        <div class="flex flex-col items-center gap-4">
            <span class="loading loading-dots loading-lg text-primary"></span>
            <div class="text-center">
                <h3 class="text-xl font-bold tracking-tight">S≈™TA</h3>
                <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest">Loading Ephemeris Data</p>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-base-100 border-b border-gray-100 sticky top-0 z-40 transform transition-all duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üïâÔ∏è</span>
                <span class="font-bold text-lg tracking-tight">S≈™TA</span>
            </div>
            <div class="flex items-center gap-2">
               <!-- Profiles Dropdown -->
               <div class="dropdown dropdown-end">
                  <label tabindex="0" class="btn btn-ghost btn-sm gap-1">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                     <span class="text-xs font-medium hidden sm:inline">Profiles</span>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </label>
                  <div tabindex="0" class="dropdown-content z-50 menu p-3 shadow-xl bg-base-100 rounded-xl w-72 border border-gray-100">
                     <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 px-2">Saved Profiles</div>
                     <ul id="profilesList" class="max-h-48 overflow-y-auto custom-scroll">
                        <li class="text-gray-400 text-xs px-2 py-2">No saved profiles</li>
                     </ul>
                     <div class="divider my-2"></div>
                     <button onclick="saveCurrentProfile()" class="btn btn-primary btn-sm w-full gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                        Save Current
                     </button>
                  </div>
               </div>
               <button id="themeToggle" onclick="toggleTheme()" class="btn btn-ghost btn-circle btn-sm">
                  <!-- Sun icon for light mode -->
                  <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                  <!-- Moon icon for dark mode -->
                  <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
               </button>
            </div>
        </div>
    </nav>

    <!-- CONTENT WRAPPER -->
    <main class="flex-grow p-4 sm:p-6 lg:p-8 w-full max-w-7xl mx-auto flex flex-col gap-8">

        <!-- INPUT SECTION (HERO) -->
        <section id="input-section" class="w-full transition-all duration-500 ease-in-out mx-auto max-w-3xl">
            <div class="card bg-base-100 shadow-xl rounded-2xl overflow-hidden border border-gray-100">
                <div class="card-body p-6 sm:p-8">
                    <div class="text-center mb-6">
                        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-pink-600">Enter Birth Details</h1>
                        <p class="text-gray-500 text-sm mt-1">Accurate calculations span 5000+ years</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Left Col: Basics -->
                        <div class="space-y-4">
                            <div class="form-control w-full input-group">
                                <label class="label pb-1"><span class="label-text text-xs font-bold uppercase text-gray-400 tracking-wider">Name</span></label>
                                <input type="text" id="name" placeholder="Name" class="input input-bordered w-full rounded-xl focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all" />
                            </div>
                            
                            <div class="form-control w-full input-group">
                                <label class="label pb-1"><span class="label-text text-xs font-bold uppercase text-gray-400 tracking-wider">Date of Birth</span></label>
                                <input type="date" id="dob" class="input input-bordered w-full rounded-xl focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all text-gray-700" />
                            </div>

                            <div class="form-control w-full input-group">
                                <label class="label pb-1"><span class="label-text text-xs font-bold uppercase text-gray-400 tracking-wider">Time of Birth</span></label>
                                <input type="time" id="tob" step="1" class="input input-bordered w-full rounded-xl focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all text-gray-700" />
                            </div>
                        </div>

                        <!-- Right Col: Location & Settings -->
                        <div class="space-y-4">
                             <div class="form-control w-full">
                                <label class="label pb-1"><span class="label-text text-xs font-bold uppercase text-gray-400 tracking-wider">Place of Birth</span></label>
                                <select id="citySelect" class="w-full" placeholder="Search City..." autocomplete="off">
                                    <option value="">Search City...</option>
                                </select>
                                <!-- HIDDEN FIELDS AUTO-POPULATED -->
                                <input type="hidden" id="selectedLat">
                                <input type="hidden" id="selectedLng">
                                <input type="hidden" id="timezone">
                            </div>
                            
                            <!-- Expandable Settings -->
                            <div class="collapse collapse-arrow border border-gray-100 rounded-xl bg-gray-50 mt-2">
                                <input type="checkbox" /> 
                                <div class="collapse-title text-xs font-bold text-gray-500">Advanced Settings</div>
                                <div class="collapse-content space-y-3"> 
                                    <div>
                                        <label class="label py-1"><span class="label-text text-xs">Ayanamsa</span></label>
                                        <select id="ayaMode" class="select select-bordered select-xs w-full rounded-lg">
                                            <option value="27">True Chitrapaksha</option>
                                            <option value="1" selected>Lahiri (Traditional)</option>
                                            <option value="5">KP (Krishnamurti)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label py-1"><span class="label-text text-xs">Positions</span></label>
                                        <select id="calcMode" class="select select-bordered select-xs w-full rounded-lg">
                                            <option value="16" selected>True Geometric</option>
                                            <option value="0">Apparent</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <button id="calcBtn" onclick="generateChart()" class="btn btn-primary w-full rounded-xl text-white text-lg font-normal tracking-wide shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all" disabled>
                            Generate Horoscope
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- OUTPUT SECTION (DASHBOARD) -->
        <section id="output" class="hidden w-full transition-opacity duration-700 opacity-0">
            
             <!-- MOBILE TAB BAR -->
             <div class="lg:hidden mb-4">
                 <div role="tablist" class="tabs tabs-boxed bg-gray-100 p-1 rounded-xl">
                     <a role="tab" class="tab tab-active rounded-lg transition-all mobile-tab" data-tab="chart" onclick="switchMobileTab('chart', this)">Chart</a>
                     <a role="tab" class="tab rounded-lg transition-all mobile-tab" data-tab="panchang" onclick="switchMobileTab('panchang', this)">Panchang</a>
                     <a role="tab" class="tab rounded-lg transition-all mobile-tab" data-tab="details" onclick="switchMobileTab('details', this)">Details</a>
                 </div>
             </div>

             <!-- DASHBOARD GRID -->
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                 
                 <!-- LEFT COLUMN: CHARTS (Sticky on Desktop) -->
                 <div class="lg:col-span-4 flex flex-col gap-6">
                     <!-- CHART CARD (mobile-tab-content) -->
                     <div id="mobile-content-chart" class="mobile-tab-content active card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-4 lg:sticky lg:top-24">
                         <div role="tablist" class="tabs tabs-boxed bg-gray-100 p-1 rounded-xl mb-4">
                             <a role="tab" class="tab tab-active rounded-lg transition-all" onclick="switchChartTab('d1', this)">Rashi (D1)</a>
                             <a role="tab" class="tab rounded-lg transition-all" onclick="switchChartTab('d9', this)">Navamsa</a>
                         </div>
                         
                         <div id="chart-container-d1" class="chart-view">
                             <div class="chart-grid" id="chart-d1"></div>
                         </div>
                         <div id="chart-container-d9" class="chart-view hidden">
                             <div class="chart-grid" id="chart-d9"></div>
                         </div>
                         
                         <!-- Rashi Legend -->
                         <div class="mt-4 p-3 bg-gray-50 rounded-xl border border-gray-100">
                             <div class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-2">Rashi Lords</div>
                             <div class="grid grid-cols-4 gap-2">
                                 <div class="legend-item"><div class="legend-swatch rashi-sun"></div><span class="text-gray-600">‚òâ Sun</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-moon"></div><span class="text-gray-600">‚òΩ Moon</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-mars"></div><span class="text-gray-600">‚ôÇ Mars</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-mercury"></div><span class="text-gray-600">‚òø Mercury</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-jupiter"></div><span class="text-gray-600">‚ôÉ Jupiter</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-venus"></div><span class="text-gray-600">‚ôÄ Venus</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-saturn"></div><span class="text-gray-600">‚ôÑ Saturn</span></div>
                             </div>
                         </div>

                         <!-- Basic Vitals Below Chart -->
                         <div class="mt-4 flex justify-between items-center px-2">
                             <div class="text-center">
                                 <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">Lagna</div>
                                 <div class="text-xl font-medium text-primary" id="val-ascDesc">-</div>
                                 <div class="text-xs font-mono text-gray-500" id="val-ascDeg">-</div>
                             </div>
                             <div class="divider divider-horizontal mx-0"></div>
                             <div class="text-center">
                                 <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">Moon Sign</div>
                                 <div class="text-xl font-medium text-secondary" id="val-moonSign">-</div>
                                 <div class="text-xs text-gray-500" id="val-moonNak">-</div>
                             </div>
                         </div>
                     </div>
                     </div>
                     
                     <!-- PANCHANGA CARD (mobile-tab-content) -->
                     <div id="mobile-content-panchang" class="mobile-tab-content">
                     <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-4">
                         <h3 class="font-bold text-gray-800 mb-3 px-2">Panchanga</h3>
                         <div class="overflow-x-auto">
                             <table class="table table-sm text-xs">
                                 <tbody>
                                     <tr class="border-b border-gray-50">
                                         <td class="text-gray-400 font-medium">Tithi</td>
                                         <td class="font-semibold text-right" id="pan-tithi">-</td>
                                     </tr>
                                     <tr class="border-b border-gray-50">
                                         <td class="text-gray-400 font-medium">Vara</td>
                                         <td class="font-semibold text-right" id="pan-vara">-</td>
                                     </tr>
                                     <tr class="border-b border-gray-50">
                                         <td class="text-gray-400 font-medium">Nakshatra</td>
                                         <td class="font-semibold text-right" id="pan-nak">-</td>
                                     </tr>
                                     <tr class="border-b border-gray-50">
                                         <td class="text-gray-400 font-medium">Yoga</td>
                                         <td class="font-semibold text-right" id="pan-yoga">-</td>
                                     </tr>
                                     <tr>
                                         <td class="text-gray-400 font-medium">Karana</td>
                                         <td class="font-semibold text-right" id="pan-karana">-</td>
                                     </tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>
                     </div>
                 </div>

                     <!-- RIGHT COLUMN: DETAILED DATA (mobile-tab-content) -->
                 <div id="mobile-content-details" class="mobile-tab-content lg:col-span-8 flex flex-col gap-8">

                     
                     <!-- PLANETARY POSITIONS -->
                     <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-6">
                         <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-2">Planetary Positions</h3>
                         <div class="overflow-x-auto custom-scroll">
                             <table class="table w-full text-center">
                                 <thead>
                                     <tr class="bg-gray-50 text-gray-500 uppercase text-xs tracking-wider">
                                         <th class="rounded-l-lg py-4">Planet</th>
                                         <th class="py-4">Rashi</th>
                                         <th class="py-4">Degree</th>
                                         <th class="py-4">Nakshatra</th>
                                         <th class="py-4">Pada</th>
                                         <th class="py-4">Lord</th>
                                        <th class="py-4">Star Lord</th>
                                         <th class="rounded-r-lg py-4">Status</th>
                                     </tr>
                                 </thead>
                                 <tbody id="planet-detail-body" class="text-sm"></tbody>
                             </table>
                         </div>
                     </div>

                     <!-- DASHA & STRENGTH -->
                     <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-6">
                         <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-2">Dasha & Strength</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div>
                                 <h4 class="font-bold text-lg mb-4 text-gray-600">Vimshottari Dasha</h4>
                                 <div class="overflow-x-auto h-96 custom-scroll border border-gray-100 rounded-lg">
                                    <table class="table table-pin-rows table-zebra w-full">
                                        <thead><tr class="bg-gray-50 text-gray-500"><th>Lord</th><th>Start</th><th>End</th><th>Dur</th></tr></thead>
                                        <tbody id="dasha-body"></tbody>
                                    </table>
                                </div>
                             </div>
                             <div>
                                 <h4 class="font-bold text-lg mb-4 text-gray-600">Shadbala Strength</h4>
                                 <div class="overflow-x-auto h-96 custom-scroll border border-gray-100 rounded-lg">
                                    <table class="table table-pin-rows table-zebra w-full text-center">
                                        <thead><tr class="bg-gray-50 text-gray-500"><th>Planet</th><th>Total</th><th>Rel</th></tr></thead>
                                        <tbody id="shadbala-body"></tbody>
                                    </table>
                                </div>
                             </div>
                         </div>
                     </div>

                     <!-- KP SYSTEM -->
                     <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-6">
                        <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-2">KP System</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <div class="badge badge-primary badge-outline mb-3 font-medium">House Cusps</div>
                                <div class="overflow-x-auto max-h-96 custom-scroll border rounded-lg">
                                    <table class="table table-zebra table-pin-rows">
                                        <thead><tr class="bg-gray-50"><th>Cusp</th><th>Sign</th><th>Deg</th><th>SgnL</th><th>StrL</th><th>SubL</th></tr></thead>
                                        <tbody id="kp-cusp-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <div class="badge badge-secondary badge-outline mb-3 font-medium">Planetary Signification</div>
                                <div class="overflow-x-auto max-h-96 custom-scroll border rounded-lg">
                                    <table class="table table-zebra table-pin-rows">
                                        <thead><tr class="bg-gray-50"><th>Pl</th><th>Deg</th><th>SgnL</th><th>StrL</th><th>SubL</th></tr></thead>
                                        <tbody id="kp-planet-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ANALYSIS -->
                    <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-6">
                        <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-2">Detailed Analysis</h3>
                        <div class="space-y-8">
                            <!-- Doshas -->
                            <div class="p-6 bg-gray-50 rounded-xl border border-gray-100">
                                <h4 class="font-bold text-sm uppercase text-gray-400 mb-4 tracking-wider">Dosha Analysis</h4>
                                <div class="flex flex-wrap gap-4" id="dosha-container"></div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="font-bold text-lg mb-4 text-gray-600">Avkahada Chakra</h4>
                                    <table class="table border rounded-lg bg-base-100">
                                        <tbody id="avkahada-body"></tbody>
                                    </table>
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg mb-4 text-gray-600">Jaimini Karakas</h4>
                                    <table class="table border rounded-lg bg-base-100">
                                        <thead><tr class="bg-gray-50"><th>Karaka</th><th>Planet</th><th>Deg</th></tr></thead>
                                        <tbody id="jaimini-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                 </div>
             </div>
        </section>

         <!-- DATA & NARRATION SECTION -->
         <section id="data-export-section" class="w-full transition-all duration-500 ease-in-out hidden">
             <div class="card bg-base-100 shadow-xl rounded-2xl overflow-hidden border border-gray-100">
                 <div class="card-body p-6 sm:p-8">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                         <h2 class="text-2xl font-bold text-gray-800">Data & Narration</h2>
                         <div class="flex items-center gap-4">
                             <!-- Toggle -->
                             <label class="cursor-pointer label gap-2">
                                 <span class="label-text font-bold text-gray-500">JSON</span> 
                                 <input type="checkbox" class="toggle toggle-primary" id="viewToggle" onchange="toggleDataView()" checked />
                                 <span class="label-text font-bold text-gray-500">Verbal</span> 
                             </label>
                             <!-- Copy Button -->
                             <button class="btn btn-outline btn-sm gap-2" onclick="copyDataToClipboard()">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                                 Copy
                             </button>
                         </div>
                     </div>

                     <!-- Content Container -->
                     <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 relative max-h-[600px] overflow-y-auto custom-scroll">
                         <!-- JSON VIEW -->
                         <pre id="json-view" class="text-xs font-mono text-gray-700 whitespace-pre-wrap hidden"></pre>
                         <!-- VERBAL CONTENT VIEW -->
                         <div id="verbal-view" class="prose prose-sm max-w-none text-gray-700 leading-relaxed space-y-4"></div>
                     </div>
                 </div>
             </div>
         </section>

         <!-- EVENT CALENDAR SECTION -->
         <section id="event-calendar-section" class="w-full transition-all duration-500 ease-in-out hidden">
             <div class="card bg-base-100 shadow-xl rounded-2xl overflow-hidden border border-gray-100">
                 <div class="card-body p-6 sm:p-8">
                     
                     <!-- Header -->
                     <div class="flex flex-col gap-4 mb-6">
                         <div>
                             <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-pink-600">
                                 Event Probability Calendar
                             </h2>
                             <p class="text-gray-500 text-sm mt-1">KP System Analysis with Deep Dasha (Pratyantar ‚Üí Sookshma)</p>
                         </div>
                         
                         <!-- Date Range Controls - Responsive -->
                         <div class="flex flex-col sm:flex-row gap-3 p-4 bg-base-200 rounded-xl">
                             <div class="flex-1">
                                 <label class="label py-1"><span class="label-text text-xs font-semibold opacity-60">From</span></label>
                                 <input type="date" id="calendarStartDate" class="input input-bordered input-sm w-full rounded-lg"/>
                             </div>
                             <div class="flex-1">
                                 <label class="label py-1"><span class="label-text text-xs font-semibold opacity-60">To</span></label>
                                 <input type="date" id="calendarEndDate" class="input input-bordered input-sm w-full rounded-lg"/>
                             </div>
                             <div class="flex items-end">
                                 <button onclick="generateEventCalendar()" class="btn btn-primary btn-sm sm:btn-md w-full sm:w-auto rounded-lg gap-2">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                     Generate
                                 </button>
                             </div>
                         </div>
                     </div>
                     
                     <!-- Event Type Pills (Search/Filter) -->
                     <div class="mb-6">
                         <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Select Event Types</div>
                         <div class="flex flex-wrap gap-2" id="event-pills-container">
                             <!-- Pills will be dynamically generated -->
                         </div>
                     </div>
                     
                     <!-- Probability Legend - Wrapping -->
                     <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4 px-2">
                         <span class="text-xs font-bold text-gray-400 w-full sm:w-auto">Probability:</span>
                         <div class="flex items-center gap-1"><div class="w-4 h-4 rounded prob-high"></div><span class="text-xs text-gray-500">High</span></div>
                         <div class="flex items-center gap-1"><div class="w-4 h-4 rounded prob-medium"></div><span class="text-xs text-gray-500">Medium</span></div>
                         <div class="flex items-center gap-1"><div class="w-4 h-4 rounded prob-low"></div><span class="text-xs text-gray-500">Low</span></div>
                         <div class="flex items-center gap-1"><div class="w-4 h-4 rounded prob-very-low border"></div><span class="text-xs text-gray-500">None</span></div>
                     </div>
                     
                     <!-- Month Navigation -->
                     <div class="month-nav mb-4 px-2">
                         <button onclick="changeCalendarMonth(-1)" class="btn btn-ghost btn-sm btn-circle">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                         </button>
                         <div class="month-title text-gray-800" id="calendar-month-title">January 2026</div>
                         <button onclick="changeCalendarMonth(1)" class="btn btn-ghost btn-sm btn-circle">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                         </button>
                     </div>
                     
                     <!-- Calendar Grid -->
                     <div class="calendar-grid" id="calendar-grid">
                         <!-- Days of week headers -->
                         <div class="calendar-header">Sun</div>
                         <div class="calendar-header">Mon</div>
                         <div class="calendar-header">Tue</div>
                         <div class="calendar-header">Wed</div>
                         <div class="calendar-header">Thu</div>
                         <div class="calendar-header">Fri</div>
                         <div class="calendar-header">Sat</div>
                         <!-- Day cells will be dynamically generated -->
                     </div>
                     
                     <!-- Current Dasha Display -->
                     <div class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-100 overflow-x-auto" id="current-dasha-display">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Current Running Dasha</div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2" id="current-dasha-lords">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Static KP Guide Section -->
                    <div class="mt-8 pt-8 border-t border-base-200">
                        <div class="collapse collapse-arrow bg-base-100 border border-base-200 rounded-lg shadow-sm">
                            <input type="checkbox" /> 
                            <div class="collapse-title text-xl font-medium flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-primary">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                                </svg>
                                KP Event Rule Book (Reference)
                            </div>
                            <div class="collapse-content"> 
                                <p class="mb-4 opacity-70 text-sm">KP Astrology assigns specific house combinations for different life events. This calendar calculates probabilities based on how many of these houses are activated by your current Dasha planets.</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üíç</span> Marriage / Relationship
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">2</span> <span class="badge badge-sm badge-neutral">7</span> <span class="badge badge-sm badge-neutral">11</span></div>
                                        <div class="text-xs opacity-60 mt-1">2=Family, 7=Spouse, 11=Desires</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üíº</span> Career / Job
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">2</span> <span class="badge badge-sm badge-neutral">6</span> <span class="badge badge-sm badge-neutral">10</span></div>
                                        <div class="text-xs opacity-60 mt-1">10=Profession, 6=Service, 2=Wealth</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üí∞</span> Finance / Money
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">2</span> <span class="badge badge-sm badge-neutral">6</span> <span class="badge badge-sm badge-neutral">11</span></div>
                                        <div class="text-xs opacity-60 mt-1">2=Accumulation, 11=Gains</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üè†</span> Property / Vehicle
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">4</span> <span class="badge badge-sm badge-neutral">11</span> <span class="badge badge-sm badge-neutral">12</span></div>
                                        <div class="text-xs opacity-60 mt-1">4=Assets, 11=Gain of Property</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üë∂</span> Childbirth
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">2</span> <span class="badge badge-sm badge-neutral">5</span> <span class="badge badge-sm badge-neutral">11</span></div>
                                        <div class="text-xs opacity-60 mt-1">5=Progeny, 2=Family extension</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>‚úàÔ∏è</span> Foreign Travel
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">3</span> <span class="badge badge-sm badge-neutral">9</span> <span class="badge badge-sm badge-neutral">12</span></div>
                                        <div class="text-xs opacity-60 mt-1">9=Long travel, 12=Foreign land</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üìö</span> Education
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">4</span> <span class="badge badge-sm badge-neutral">9</span> <span class="badge badge-sm badge-neutral">11</span></div>
                                        <div class="text-xs opacity-60 mt-1">4=Basic, 9=Higher Education</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üè•</span> Health Issues
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">1</span> <span class="badge badge-sm badge-neutral">6</span> <span class="badge badge-sm badge-neutral">8</span></div>
                                        <div class="text-xs opacity-60 mt-1">6=Disease, 8=Chronic/Surgery</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>‚öñÔ∏è</span> Legal / Litigation
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">6</span> <span class="badge badge-sm badge-neutral">7</span> <span class="badge badge-sm badge-neutral">12</span></div>
                                        <div class="text-xs opacity-60 mt-1">6=Arguments, 12=Punishment</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     
                 </div>
             </div>
         </section>
    </main>

    <!-- DAY DETAIL MODAL -->
    <div id="day-modal-backdrop" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" onclick="closeDayModal()">
        <div class="modal-box w-full max-w-lg bg-base-100 rounded-xl shadow-2xl relative" onclick="event.stopPropagation()">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeDayModal()">‚úï</button>
            
            <h3 id="modal-date-title" class="font-bold text-xl mb-4 text-center">Date Here</h3>
            
            <!-- Dasha Chain -->
            <div class="bg-base-200 p-3 rounded-lg mb-6 overflow-x-auto">
                <div class="text-center text-xs opacity-50 mb-2 uppercase tracking-wide font-bold">Active Dasha Chain</div>
                <div id="modal-dasha-chain" class="grid grid-cols-4 gap-2 text-center min-w-max">
                    <!-- JS Injected -->
                </div>
            </div>
            
            <div class="divider text-xs opacity-50">PREDICTED EVENTS</div>
            
            <!-- Events List -->
            <div id="modal-events-list" class="max-h-[50vh] overflow-y-auto custom-scroll pr-1">
                <!-- JS Injected -->
            </div>
            
            <div class="modal-action justify-center mt-6">
                <button class="btn btn-primary w-full" onclick="closeDayModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import astroEngine from './VedicAstroEngine.js';
        import jyotishTools from './JyotishTools.js';
        import kpEventEngine, { EVENT_TYPES } from './KPEventEngine.js';

        let tsControl;
        
        // --- CALENDAR STATE ---
        let calendarData = [];           // Generated calendar array
        let calendarNatalData = null;    // Natal chart data for calendar
        let activeEventTypes = new Set(['marriage', 'career', 'finance']); // Default selections
        let currentCalendarMonth = new Date();  // Currently displayed month
        let calendarBirthDate = null;
        let calendarMoonLong = 0;

        window.onload = async () => {
            try {
                const loader = document.getElementById('loader');

                // Initialize Engine
                await astroEngine.init();
                
                // Initialize TomSelect (Empty first)
                tsControl = new TomSelect("#citySelect", {
                    valueField: 'id',
                    labelField: 'n',
                    searchField: ['n', 'st'], // Search both name and state
                    maxOptions: 50,
                    create: false,
                    placeholder: "Search City (e.g. Mumbai, New York)",
                    render: {
                        option: function(data, escape) {
                            return '<div class="flex justify-between items-center py-1"><span>' + escape(data.n) + '</span> <span class="text-xs text-gray-400 uppercase tracking-widest ml-2">' + escape(data.st) + '</span></div>';
                        },
                        item: function(data, escape) {
                            return '<div>' + escape(data.n) + ', ' + escape(data.st) + '</div>';
                        }
                    },
                    onChange: (value) => {
                        if(value && tsControl.options[value]) {
                            const data = tsControl.options[value];
                            document.getElementById('selectedLat').value = data.lat;
                            document.getElementById('selectedLng').value = data.lng;
                            document.getElementById('timezone').value = data.tz;
                            console.log("Selected:", data);
                        }
                    }
                });
                tsControl.disable(); // Disable until data loads

                // Load City Data
                // Fetch GZIPPED file to save bandwidth
                // Format: [Name, Lat, Lng, Tz, State]
                const res = await fetch('./indian_locations_state.json.gz');
                const buffer = await res.arrayBuffer();
                
                // Decompress
                const text = pako.ungzip(buffer, { to: 'string' });
                const rawData = JSON.parse(text);
                
                // Optimize mapping 
                // Filter garbage (starts with digit or too short)
                const options = rawData
                    .filter(d => !/^\d/.test(d[0]) && d[0].length > 2)
                    .map((d, i) => ({
                        id: i,
                        n: d[0],
                        lat: d[1],
                        lng: d[2],
                        tz: d[3],
                        st: d[4] // State index
                    }));
                
                tsControl.addOptions(options);
                tsControl.enable();
                
                loader.classList.add('hidden');
                document.getElementById('calcBtn').disabled = false;

            } catch (e) {
                console.error(e);
                alert("Init Failed: " + e.message);
                document.getElementById('loader').classList.add('hidden'); // Ensure loader hides on error
            }
        };

        window.generateChart = () => {
             const dateStr = document.getElementById('dob').value;
             const timeStr = document.getElementById('tob').value;
             // Timezone is now a STRING (IANA)
             const tzString = document.getElementById('timezone').value;
             const lat = parseFloat(document.getElementById('selectedLat').value);
             const lng = parseFloat(document.getElementById('selectedLng').value);
             const ayaMode = parseInt(document.getElementById('ayaMode').value);
             const calcMode = parseInt(document.getElementById('calcMode').value);

             if(!dateStr || !timeStr || isNaN(lat)) { 
                 alert("Please enter all details including a valid city."); 
                 return; 
             }
             
             // Calculate Numeric Offset from IANA string
             const tzOffset = getOffsetFromIANA(tzString, dateStr, timeStr);
             console.log("Calculated Offset for", tzString, "is", tzOffset);

             try {
                const button = document.getElementById('calcBtn');
                button.classList.add('loading');
                
                setTimeout(() => {
                    // Main Calc
                    const d1Result = astroEngine.calculate(dateStr, timeStr, tzOffset, lat, lng, {
                        ayanamsaMode: ayaMode,
                        calcModeFlag: calcMode,
                        houseSystem: 'P' 
                    });
                    
                    const kpResult = astroEngine.calculate(dateStr, timeStr, tzOffset, lat, lng, {
                         ayanamsaMode: ayaMode,
                         calcModeFlag: calcMode,
                         houseSystem: 'P'
                    });

                    d1Result.planets.forEach(p => {
                        p.vargas = {
                             d1: jyotishTools.getVargaPosition(p.longitude, 1),
                             d9: jyotishTools.getVargaPosition(p.longitude, 9)
                        };
                    });

                    const moonObj = d1Result.planets.find(p => p.name === "Moon");
                    const dashas = jyotishTools.calculateVimshottari(moonObj.longitude, dateStr);

                    const kpData = {
                        planets: kpResult.planets.map(p => ({ ...p, kp: jyotishTools.getKPLords(p.longitude) })),
                        cusps: kpResult.houses.houses.map((deg, idx) => {
                            const hNum = idx; 
                            if (hNum === 0) return null; 
                            return { id: hNum, dms: astroEngine.decimalToDMS(deg), kp: jyotishTools.getKPLords(deg) };
                        }).filter(x => x!==null)
                    };

                    const shadbala = jyotishTools.calculateShadbala(d1Result.planets);
                    const jaimini = jyotishTools.calculateJaimini(d1Result.planets);
                    const doshas = jyotishTools.checkDoshas(d1Result.planets);
                    const avkahada = jyotishTools.getAvkahada(moonObj.longitude);
                    const ashtakvarga = jyotishTools.calculateAshtakvarga(d1Result.planets);

                    renderDashboard(d1Result, dashas, kpData, shadbala, jaimini, doshas, avkahada, ashtakvarga);
                    
                    // --- CALENDAR DATA STORAGE ---
                    calendarBirthDate = dateStr;
                    calendarMoonLong = moonObj.longitude;
                    calendarNatalData = {
                        planets: d1Result.planets,
                        kpCusps: kpData.cusps
                    };
                    
                    // Set default calendar date range (today + 90 days)
                    const today = new Date();
                    document.getElementById('calendarStartDate').value = today.toISOString().split('T')[0];
                    const endDate = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
                    document.getElementById('calendarEndDate').value = endDate.toISOString().split('T')[0];
                    
                    // Initialize event pills
                    initEventPills();
                    
                    // Calculate and render current running dasha immediately
                    const currentDasha = kpEventEngine.calculateDeepDasha(
                        calendarMoonLong,
                        calendarBirthDate,
                        today
                    );
                    renderCurrentDasha(currentDasha);
                    
                    button.classList.remove('loading');
                    // Scroll to Output
                    document.getElementById('output').classList.remove('hidden');
                    document.getElementById('event-calendar-section').classList.remove('hidden');
                    setTimeout(() => {
                         document.getElementById('output').classList.remove('opacity-0');
                         document.getElementById('output').scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                    
                }, 50); // Small delay for UI update

             } catch(e) {
                 console.error(e);
                 alert("Calc Error: " + e.message);
                 document.getElementById('calcBtn').classList.remove('loading');
             }
        };
        
        function getOffsetFromIANA(timeZone, dateStr, timeStr) {
            try {
                // "Asia/Kolkata", "2000-01-01", "12:00"
                // Construct date string for Intl
                const dt = new Date(`${dateStr}T${timeStr}`);
                
                // Get timezone specific string
                // options: timeZoneName: 'longOffset' returns "GMT+05:30"
                const str = dt.toLocaleString('en-US', { timeZone: timeZone, timeZoneName: 'longOffset' });
                
                // Check if result has GMT or UTC
                const match = str.match(/GMT([+-]\d{2}):(\d{2})/);
                if (match) {
                    const hours = parseInt(match[1]);
                    const minutes = parseInt(match[2]);
                    const sign = hours < 0 ? -1 : 1;
                    // Note: match[1] includes sign. parseInt("-05") is -5.
                    // If hours is -5, we subtract minutes? No. -5:30 means -(5 + 30/60).
                    // Logic: Absolute hours + minutes/60, then apply sign.
                    // Actually, if string is GMT-05:30. hours = -5. minutes = 30.
                    // We want -5.5.
                    // Math.abs(hours) + minutes/60 -> 5.5. Then apply sign.
                    const offset = (Math.abs(hours) + (minutes / 60)) * (hours >= 0 ? 1 : -1);
                    return offset;
                }
                
                if (str.includes("GMT") && !str.includes("GMT+")) return 0; // GMT+00:00 sometimes shows as GMT

                console.warn("Could not parse offset from", str, "Defaulting to 5.5");
                return 5.5; // Fallback
            } catch (e) {
                console.error("Timezone Parse Error", e);
                return 5.5; 
            }
        }

        function renderDashboard(data, dashas, kpData, shadbala, jaimini, doshas, avkahada, ashtakvarga) {
            // Safe fix: Check if element exists before setting.
            const ayaEl = document.getElementById('val-ayanamsa');
            if(ayaEl) ayaEl.innerText = astroEngine.decimalToDMS(data.meta.ayanamsaValue);

            const asc = data.planets[0];
            const moon = data.planets.find(p => p.name === "Moon");
            
            setText('val-ascDesc', asc.sign);
            setText('val-ascDeg', asc.dms);
            setText('val-moonSign', moon.sign);
            setText('val-moonNak', moon.nakshatra);
            
            setText('pan-tithi', data.panchanga.tithi);
            setText('pan-vara', data.panchanga.vara);
            setText('pan-nak', data.panchanga.nakshatra);
            setText('pan-yoga', data.panchanga.yoga);
            setText('pan-karana', data.panchanga.karana);

            // Get ascendant sign ID for house calculations
            const ascSignId = asc.signId; // 0-indexed (0=Aries)
            
            renderSouthChart('chart-d1', data.planets, 'd1', ascSignId);
            // For D9, lagna is based on navamsa ascendant
            const d9AscSignId = asc.vargas.d9.signId;
            renderSouthChart('chart-d9', data.planets, 'd9', d9AscSignId);

            const tbody = document.getElementById('planet-detail-body');
            tbody.innerHTML = '';
            data.planets.forEach(p => {
                const signLord = jyotishTools.getSignLord(p.sign);
                const starLord = jyotishTools.getNakshatraLord(p.nakshatraId);
                const pada = Math.floor((p.longitude % 13.3333333) / 3.3333333) + 1;
                const status = (p.isRetrograde) 
                    ? '<span class="badge badge-warning badge-xs">Ret</span>' 
                    : '<span class="badge badge-ghost badge-xs text-gray-400">Dir</span>';
                
                tbody.innerHTML += `<tr class="hover:bg-gray-50 transition-colors">
                    <td class="font-bold text-gray-700 flex items-center justify-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-[10px] planet-${p.name}">${p.name.substring(0,2)}</span>
                        ${p.name}
                    </td>
                    <td>${p.sign}</td>
                    <td class="font-mono text-xs text-gray-500">${p.dms}</td>
                    <td>${p.nakshatra}</td>
                    <td>${pada}</td>
                    <td>${signLord}</td>
                    <td class="font-bold text-primary">${starLord}</td>
                    <td>${status}</td>
                </tr>`;
            });

            // KP
            const cuspsBody = document.getElementById('kp-cusp-body');
            cuspsBody.innerHTML = '';
            kpData.cusps.forEach(c => {
                const k = c.kp;
                cuspsBody.innerHTML += `<tr class="hover:bg-gray-50">
                    <td class="font-bold text-gray-400">H${c.id}</td>
                    <td>${k.sign}</td>
                    <td class="font-mono text-xs">${c.dms}</td>
                    <td>${k.signLord}</td>
                    <td>${k.starLord}</td>
                    <td class="font-bold text-primary">${k.subLord}</td>
                </tr>`;
            });

            const kpPlBody = document.getElementById('kp-planet-body');
            kpPlBody.innerHTML = '';
            kpData.planets.forEach(p => {
                const k = p.kp;
                kpPlBody.innerHTML += `<tr class="hover:bg-gray-50">
                    <td class="font-bold flex gap-1 justify-center"><span class="planet-${p.name}">${p.name.substring(0,2)}</span></td>
                    <td class="font-mono text-xs">${p.dms}</td>
                    <td>${k.signLord}</td>
                    <td>${k.starLord}</td>
                    <td class="font-bold text-primary">${k.subLord}</td>
                </tr>`;
            });

            // SHADBALA
            const shadBody = document.getElementById('shadbala-body');
            shadBody.innerHTML = '';
            Object.keys(shadbala).forEach(key => {
                const s = shadbala[key];
                // Relative strength rough calc: > 1.0 (some standard ratios exist but simplified here)
                // Just showing total for now
                shadBody.innerHTML += `<tr>
                    <td class="font-bold text-left pl-4">${key}</td>
                    <td class="font-bold text-primary">${s.total}</td>
                    <td class="text-xs text-gray-400">RP</td>
                </tr>`;
            });

            // DASHAS - Store globally for deep dive
            window.calculatedDashas = dashas;
            const dashaBody = document.getElementById('dasha-body');
            dashaBody.innerHTML = '';
            dashas.forEach((d, idx) => {
                // Check if current date is within this Mahadasha
                const now = new Date();
                const isCurrent = now >= d.start && now <= d.end;
                const currentClass = isCurrent ? 'bg-primary/10' : '';
                
                dashaBody.innerHTML += `<tr class="dasha-row cursor-pointer hover:bg-gray-100 ${currentClass}" data-dasha-idx="${idx}" onclick="toggleDashaExpand(${idx})">
                    <td class="font-bold flex items-center gap-1">
                        <svg class="h-3 w-3 transition-transform dasha-arrow" id="dasha-arrow-${idx}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        ${d.lord}
                    </td>
                    <td class="font-mono text-xs">${d.start.toLocaleDateString()}</td>
                    <td class="font-mono text-xs">${d.end.toLocaleDateString()}</td>
                    <td class="text-gray-400">${d.duration.toFixed(1)}y</td>
                </tr>
                <tr class="dasha-expand hidden" id="dasha-expand-${idx}">
                    <td colspan="4" class="p-0">
                        <div class="pl-6 py-2 bg-gray-50 border-l-2 border-primary" id="antardasha-container-${idx}"></div>
                    </td>
                </tr>`;
            });

            // SPECIALTY
            document.getElementById('avkahada-body').innerHTML = `
                <tr class="border-b border-gray-50"><td>Gana</td><td class="font-bold text-gray-700 text-right">${avkahada.gana}</td></tr>
                <tr class="border-b border-gray-50"><td>Yoni</td><td class="font-bold text-gray-700 text-right">${avkahada.yoni}</td></tr>
                <tr><td>Nadi</td><td class="font-bold text-gray-700 text-right">${avkahada.nadi}</td></tr>
            `;

            const jmBody = document.getElementById('jaimini-body');
            jmBody.innerHTML = '';
            jaimini.forEach(k => {
                jmBody.innerHTML += `<tr>
                    <td class="font-bold text-primary">${k.karaka}</td>
                    <td>${k.planet}</td>
                    <td class="font-mono text-xs">${k.degree}¬∞</td>
                </tr>`;
            });

            const doshaContainer = document.getElementById('dosha-container');
            doshaContainer.innerHTML = '';
            if(doshas.manglik.isPresent) {
                doshaContainer.innerHTML += `<div class="badge badge-error badge-outline gap-2 p-3 font-medium">Manglik: ${doshas.manglik.reason}</div>`;
            } else {
                doshaContainer.innerHTML += `<div class="badge badge-success badge-outline gap-2 p-3 font-medium">No Manglik Dosha</div>`;
            }
            if(doshas.kalsarpa.isPresent) {
                doshaContainer.innerHTML += `<div class="badge badge-warning badge-outline gap-2 p-3 font-medium">Kalsarpa: ${doshas.kalsarpa.type}</div>`;
            }

            renderDataExport(data, dashas, kpData, shadbala, jaimini, doshas, avkahada, ashtakvarga);
        }
        
        function setText(id, val) {
            const el = document.getElementById(id);
            if(el) el.innerText = val;
        }

        // Rashi data: [English Name, Sanskrit Abbrev, Lord]
        const RASHI_DATA = [
            ["Aries", "Me·π£", "Mars"],
            ["Taurus", "V·πõ·π£", "Venus"],
            ["Gemini", "Mith", "Mercury"],
            ["Cancer", "Kark", "Moon"],
            ["Leo", "Si·πÉh", "Sun"],
            ["Virgo", "KanyƒÅ", "Mercury"],
            ["Libra", "TulƒÅ", "Venus"],
            ["Scorpio", "V·πõ≈õ", "Mars"],
            ["Sagittarius", "Dhan", "Jupiter"],
            ["Capricorn", "Mak", "Saturn"],
            ["Aquarius", "Kumb", "Saturn"],
            ["Pisces", "Mƒ´n", "Jupiter"]
        ];
        
        // Map lord name to CSS class
        function getLordClass(lordName) {
            const lordClasses = {
                "Sun": "rashi-sun",
                "Moon": "rashi-moon",
                "Mars": "rashi-mars",
                "Mercury": "rashi-mercury",
                "Jupiter": "rashi-jupiter",
                "Venus": "rashi-venus",
                "Saturn": "rashi-saturn"
            };
            return lordClasses[lordName] || "";
        }

        function renderSouthChart(containerId, planets, vargaKey, lagnaSignId = 0) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for(let i=0; i<16; i++) {
                const div = document.createElement('div');
                if (i===5 || i===6 || i===9 || i===10) {
                     if(i===5) {
                         div.className = "chart-center";
                         div.innerHTML = `<span class="font-bold text-gray-300 text-[10px] border border-gray-700 tracking-widest">${vargaKey.toUpperCase()}</span>`;
                         container.appendChild(div);
                     }
                     continue; 
                 }
                 
                 // Get sign ID (1-12 based)
                 let signId = 0;
                 if(i===0) signId=12; else if(i===1) signId=1; else if(i===2) signId=2; else if(i===3) signId=3;
                 else if(i===4) signId=11; else if(i===7) signId=4;
                 else if(i===8) signId=10; else if(i===11) signId=5;
                 else if(i===12) signId=9; else if(i===13) signId=8; else if(i===14) signId=7; else if(i===15) signId=6;
                 
                 // Get rashi data (0-indexed)
                 const rashiInfo = RASHI_DATA[signId - 1];
                 const rashiName = rashiInfo[0];
                 const rashiAbbrev = rashiInfo[1];
                 const rashiLord = rashiInfo[2];
                 const lordClass = getLordClass(rashiLord);
                 
                 // Calculate house number (bhava) from lagna
                 // lagnaSignId is 0-indexed, signId is 1-indexed
                 // House 1 = lagna sign, House 2 = lagna+1, etc.
                 const houseNum = ((signId - 1 - lagnaSignId + 12) % 12) + 1;
                 
                 div.className = `chart-cell border-[0.5px] border-gray-100 hover:shadow-inner ${lordClass}`;
                 
                 // Add house number (top-left) and rashi with sign number (bottom-right)
                 div.innerHTML = `
                     <span class="house-label">${houseNum}</span>
                     <span class="rashi-label text-gray-500">${rashiAbbrev} (${signId})</span>
                 `;
                 
                 planets.forEach(p => {
                     const pSignId = p.vargas[vargaKey].signId + 1;
                     if(pSignId === signId) {
                         const pSpan = document.createElement('span');
                         pSpan.className = `planet-glyph planet-${p.name}`;
                         pSpan.innerText = p.name.substring(0,2);
                         div.appendChild(pSpan);
                     }
                 });
                 container.appendChild(div);
            }
        }

        /* -----------------------------------------------------
           DATA EXPORT & NARRATION LOGIC
           ----------------------------------------------------- */
        
        let exportData = { json: "", verbal: "" };

        function renderDataExport(data, dashas, kpData, shadbala, jaimini, doshas, avkahada, ashtakvarga) {
            
            // Construct full JSON object (clean clone or subset if circular refs exist - usually fine here)
            const fullObj = {
                basic: {
                    name: document.getElementById('name').value,
                    dob: document.getElementById('dob').value,
                    tob: document.getElementById('tob').value,
                    place: (tsControl && tsControl.getValue() !== "") ? tsControl.options[tsControl.getValue()].n : "Unknown",
                },
                meta: data.meta,
                panchanga: data.panchanga,
                planets: data.planets,
                kp: kpData,
                dashas: dashas,
                shadbala: shadbala,
                jaimini: jaimini,
                doshas: doshas,
                avkahada: avkahada,
                ashtakvarga: ashtakvarga
            };

            exportData.json = JSON.stringify(fullObj, null, 2);
            exportData.verbal = generateVerbalNarration(fullObj);

            // Render
            document.getElementById('json-view').innerText = exportData.json;
            // Simple formatter for verbal text
            document.getElementById('verbal-view').innerHTML = formatVerbalToHtml(exportData.verbal);

            document.getElementById('data-export-section').classList.remove('hidden');
        }

        function generateVerbalNarration(D) {
            let txt = "";
            const d = D.basic;
            const p = D.planets;

            // Header
            txt += `### Horoscope Details\n`;
            txt += `**Name:** ${d.name || "User"}  \n`;
            txt += `**Date of Birth:** ${d.dob}  \n`;
            txt += `**Time of Birth:** ${d.tob}  \n`;
            txt += `**Place:** ${d.place}  \n`;
            txt += `**Ayanamsa:** ${astroEngine.decimalToDMS(D.meta.ayanamsaValue)} (${document.getElementById('ayaMode').selectedOptions[0].text})\n\n`;

            // Panchanga
            txt += `### Panchanga\n`;
            txt += `- **Tithi:** ${D.panchanga.tithi}\n`;
            txt += `- **Vara (Day):** ${D.panchanga.vara}\n`;
            txt += `- **Nakshatra:** ${D.panchanga.nakshatra}\n`;
            txt += `- **Yoga:** ${D.panchanga.yoga}\n`;
            txt += `- **Karana:** ${D.panchanga.karana}\n\n`;

            // Planetary Details
            txt += `### Planetary Positions\n`;
            p.forEach(pl => {
                const signLord = jyotishTools.getSignLord(pl.sign);
                const pada = Math.floor((pl.longitude % 13.3333333) / 3.3333333) + 1;
                const status = (pl.isRetrograde) ? "Retrograde" : "Direct";
                
                txt += `- **${pl.name}:** Placed in **${pl.sign}** at **${pl.dms}**.\n`;
                txt += `  - Nakshatra: ${pl.nakshatra} (Pada ${pada})\n`;
                txt += `  - Sign Lord: ${signLord}\n`;
                txt += `  - Status: ${status}\n`;
            });
            txt += "\n";

            // Dasha
            txt += `### Vimshottari Dasha Rules\n`;
            D.dashas.forEach(dasha => {
                txt += `- **${dasha.lord} Dasha:** From ${new Date(dasha.start).toLocaleDateString()} to ${new Date(dasha.end).toLocaleDateString()} (${dasha.duration.toFixed(2)} Years)\n`;
            });
            txt += "\n";

            // Shadbala
            txt += `### Shadbala Strength\n`;
            Object.keys(D.shadbala).forEach(k => {
                txt += `- **${k}:** ${D.shadbala[k].total} Rupas\n`;
            });
            txt += "\n";

            // KP System
            txt += `### KP System Analysis\n`;
            txt += `**House Cusps (Bhavas):**\n`;
            D.kp.cusps.forEach(c => {
                 const k = c.kp;
                 txt += `- **House ${c.id}:** ${c.dms} in ${k.sign}. [SignL: ${k.signLord} | StarL: ${k.starLord} | SubL: ${k.subLord}]\n`;
            });
            txt += `\n**Planetary Significations:**\n`;
            D.kp.planets.forEach(pl => {
                const k = pl.kp;
                 txt += `- **${pl.name}:** [SignL: ${k.signLord} | StarL: ${k.starLord} | SubL: ${k.subLord}]\n`;
            });
            txt += "\n";

            // Analysis
            txt += `### Detailed Analysis\n`;
            txt += `**Avkahada Chakra:**\n`;
            txt += `- Gana: ${D.avkahada.gana}\n`;
            txt += `- Yoni: ${D.avkahada.yoni}\n`;
            txt += `- Nadi: ${D.avkahada.nadi}\n\n`;

            txt += `**Jaimini Karakas:**\n`;
            D.jaimini.forEach(j => {
                txt += `- ${j.karaka}: ${j.planet} (${j.degree}¬∞)\n`;
            });
            txt += "\n";

            txt += `**Dosha Analysis:**\n`;
            txt += `- **Manglik:** ${D.doshas.manglik.isPresent ? "Present (" + D.doshas.manglik.reason + ")" : "Absent"}\n`;
            txt += `- **Kalsarpa:** ${D.doshas.kalsarpa.isPresent ? "Present (" + D.doshas.kalsarpa.type + ")" : "Absent"}\n`;

            return txt;
        }

        function formatVerbalToHtml(text) {
            // Convert markdown style to HTML
            // IMPORTANT: Process headers and lists BEFORE replacing newlines
            return text
                .replace(/^### (.*?)$/gm, '<h3 class="text-lg font-bold text-primary mt-6 mb-2 border-b border-gray-100 pb-1">$1</h3>')
                .replace(/^- (.*?)$/gm, '<div class="ml-4 mb-1">‚Ä¢ $1</div>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
                .replace(/\n/g, '<br>');
        }

        window.toggleDataView = () => {
            const isVerbal = document.getElementById('viewToggle').checked;
            const jsonEl = document.getElementById('json-view');
            const verbalEl = document.getElementById('verbal-view');

            if(isVerbal) {
                jsonEl.classList.add('hidden');
                verbalEl.classList.remove('hidden');
            } else {
                verbalEl.classList.add('hidden');
                jsonEl.classList.remove('hidden');
            }
        }

        window.copyDataToClipboard = () => {
            const isVerbal = document.getElementById('viewToggle').checked;
            const content = isVerbal ? exportData.verbal : exportData.json;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.querySelector('#data-export-section button');
                const orig = btn.innerHTML;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Copied!`;
                setTimeout(() => { btn.innerHTML = orig }, 2000);
            });
        }

        window.switchChartTab = (chartKey, tabElement) => {
             // 1. Hide all chart views
             document.querySelectorAll('.chart-view').forEach(el => el.classList.add('hidden'));
             
             // 2. Show selected
             document.getElementById(`chart-container-${chartKey}`).classList.remove('hidden');
             
             // 3. Update Tab Styles
             const parent = tabElement.parentElement;
             parent.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
             tabElement.classList.add('tab-active');
        };

        /* -----------------------------------------------------
           MOBILE TAB NAVIGATION
           ----------------------------------------------------- */
        
        window.switchMobileTab = (tabKey, tabElement) => {
            // Remove active from all mobile content containers
            document.querySelectorAll('.mobile-tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Add active to selected tab content
            const targetContent = document.getElementById(`mobile-content-${tabKey}`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // Update tab styles
            document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('tab-active'));
            tabElement.classList.add('tab-active');
        };

        /* -----------------------------------------------------
           DASHA DEEP DIVE (Antardasha Expansion)
           ----------------------------------------------------- */
        
        const VIM_ORDER = ["Ketu", "Venus", "Sun", "Moon", "Mars", "Rahu", "Jupiter", "Saturn", "Mercury"];
        const DASHA_YEARS = { "Ketu": 7, "Venus": 20, "Sun": 6, "Moon": 10, "Mars": 7, "Rahu": 18, "Jupiter": 16, "Saturn": 19, "Mercury": 17 };
        
        function calculateAntardasha(mahadasha) {
            const results = [];
            const totalDays = (mahadasha.end - mahadasha.start) / (1000 * 60 * 60 * 24);
            const startIdx = VIM_ORDER.indexOf(mahadasha.lord);
            let currentDate = new Date(mahadasha.start);
            
            for (let i = 0; i < 9; i++) {
                const idx = (startIdx + i) % 9;
                const lord = VIM_ORDER[idx];
                const proportion = DASHA_YEARS[lord] / 120; // 120 = total Vimshottari years
                const days = totalDays * proportion;
                
                const endDate = new Date(currentDate);
                endDate.setTime(endDate.getTime() + (days * 24 * 60 * 60 * 1000));
                
                results.push({
                    lord: lord,
                    start: new Date(currentDate),
                    end: new Date(endDate),
                    durationMonths: (days / 30.4375).toFixed(1)
                });
                
                currentDate = new Date(endDate);
            }
            return results;
        }
        
        window.toggleDashaExpand = (idx) => {
            const expandRow = document.getElementById(`dasha-expand-${idx}`);
            const arrow = document.getElementById(`dasha-arrow-${idx}`);
            const container = document.getElementById(`antardasha-container-${idx}`);
            
            if (expandRow.classList.contains('hidden')) {
                // Expand - Calculate Antardasha
                expandRow.classList.remove('hidden');
                arrow.style.transform = 'rotate(90deg)';
                
                // Calculate Antardasha for this Mahadasha
                const mahadasha = window.calculatedDashas[idx];
                const antardashas = calculateAntardasha(mahadasha);
                
                let html = '<table class="table table-xs w-full">';
                html += '<thead><tr class="text-gray-400 text-[10px]"><th>Bhukti</th><th>Start</th><th>End</th><th>Dur</th></tr></thead>';
                html += '<tbody>';
                
                const now = new Date();
                antardashas.forEach(ad => {
                    const isCurrent = now >= ad.start && now <= ad.end;
                    const rowClass = isCurrent ? 'bg-primary/20 font-semibold' : '';
                    html += `<tr class="${rowClass}">
                        <td class="font-medium">${mahadasha.lord}-${ad.lord}</td>
                        <td class="font-mono text-[10px]">${ad.start.toLocaleDateString()}</td>
                        <td class="font-mono text-[10px]">${ad.end.toLocaleDateString()}</td>
                        <td class="text-gray-400">${ad.durationMonths}m</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } else {
                // Collapse
                expandRow.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        /* -----------------------------------------------------
           PROFILE MANAGEMENT (localStorage)
           ----------------------------------------------------- */
        
        const PROFILES_KEY = 'suta_profiles';
        
        function getProfiles() {
            const data = localStorage.getItem(PROFILES_KEY);
            return data ? JSON.parse(data) : [];
        }
        
        function saveProfiles(profiles) {
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
        }
        
        function renderProfilesList() {
            const profiles = getProfiles();
            const list = document.getElementById('profilesList');
            
            if (profiles.length === 0) {
                list.innerHTML = '<li class="text-gray-400 text-xs px-2 py-2">No saved profiles</li>';
                return;
            }
            
            list.innerHTML = profiles.map((p, idx) => `
                <li class="grid grid-cols-[1fr_auto_auto] items-center gap-3 px-2 py-2 hover:bg-gray-50 rounded-lg">
                    <button onclick="loadProfile(${idx})" class="text-left text-sm font-medium text-gray-700 hover:text-primary truncate">
                        ${p.name || 'Unnamed'}
                    </button>
                    <span class="text-[10px] text-gray-400 whitespace-nowrap">${p.dob}</span>
                    <button onclick="deleteProfile(${idx})" class="btn btn-ghost btn-xs text-gray-400 hover:text-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </li>
            `).join('');
        }
        
        window.saveCurrentProfile = () => {
            const name = document.getElementById('name').value.trim();
            const dob = document.getElementById('dob').value;
            const tob = document.getElementById('tob').value;
            const cityValue = tsControl ? tsControl.getValue() : '';
            
            if (!name) {
                alert('Please enter a name to save the profile.');
                return;
            }
            if (!dob || !tob) {
                alert('Please fill in date and time of birth.');
                return;
            }
            
            // Get city data
            let cityData = null;
            if (cityValue && tsControl.options[cityValue]) {
                const c = tsControl.options[cityValue];
                cityData = { id: cityValue, n: c.n, lat: c.lat, lng: c.lng, tz: c.tz, st: c.st };
            }
            
            const profile = {
                name: name,
                dob: dob,
                tob: tob,
                city: cityData,
                ayaMode: document.getElementById('ayaMode').value,
                calcMode: document.getElementById('calcMode').value,
                savedAt: new Date().toISOString()
            };
            
            const profiles = getProfiles();
            
            // Check if profile with same name exists
            const existingIdx = profiles.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
            if (existingIdx >= 0) {
                if (confirm(`Profile "${name}" already exists. Do you want to update it?`)) {
                    profiles[existingIdx] = profile;
                } else {
                    return;
                }
            } else {
                profiles.push(profile);
            }
            
            saveProfiles(profiles);
            renderProfilesList();
            
            // Flash feedback
            const btn = document.querySelector('[onclick="saveCurrentProfile()"]');
            const origText = btn.innerHTML;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Saved!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-primary');
            setTimeout(() => {
                btn.innerHTML = origText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 1500);
        };
        
        window.loadProfile = (idx) => {
            const profiles = getProfiles();
            const p = profiles[idx];
            if (!p) return;
            
            // Set form values
            document.getElementById('name').value = p.name || '';
            document.getElementById('dob').value = p.dob || '';
            document.getElementById('tob').value = p.tob || '';
            document.getElementById('ayaMode').value = p.ayaMode || '27';
            document.getElementById('calcMode').value = p.calcMode || '16';
            
            // Set city if available
            if (p.city && tsControl) {
                // Add the option if not present
                if (!tsControl.options[p.city.id]) {
                    tsControl.addOption(p.city);
                }
                tsControl.setValue(p.city.id, true);
                
                // Set hidden fields
                document.getElementById('selectedLat').value = p.city.lat;
                document.getElementById('selectedLng').value = p.city.lng;
                document.getElementById('timezone').value = p.city.tz;
            }
            
            // Close dropdown
            document.activeElement.blur();
            
            // Visual feedback - scroll to input section
            document.getElementById('input-section').scrollIntoView({ behavior: 'smooth' });
        };
        
        window.deleteProfile = (idx) => {
            const profiles = getProfiles();
            const p = profiles[idx];
            if (!p) return;
            
            if (confirm(`Delete profile "${p.name}"?`)) {
                profiles.splice(idx, 1);
                saveProfiles(profiles);
                renderProfilesList();
            }
        };
        
        // Initialize profiles list on page load
        setTimeout(renderProfilesList, 100);

        /* -----------------------------------------------------
           DARK/LIGHT THEME TOGGLE
           ----------------------------------------------------- */
        
        const THEME_KEY = 'suta_theme';
        
        function getStoredTheme() {
            return localStorage.getItem(THEME_KEY) || 'light';
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem(THEME_KEY, theme);
            updateThemeIcons(theme);
        }
        
        function updateThemeIcons(theme) {
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            if (sunIcon && moonIcon) {
                if (theme === 'dark') {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }
        }
        
        window.toggleTheme = () => {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = current === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        };
        
        
        /* =====================================================
           EVENT CALENDAR FUNCTIONS
           ===================================================== */
        
        // Initialize event pills
        function initEventPills() {
            const container = document.getElementById('event-pills-container');
            if (!container) return;
            
            container.innerHTML = EVENT_TYPES.map(evt => {
                const isActive = activeEventTypes.has(evt.id);
                return `<div class="event-pill ${isActive ? 'active' : ''}" data-event-id="${evt.id}" onclick="toggleEventPill('${evt.id}')">
                    <span class="pill-icon">${evt.icon}</span>
                    <span>${evt.name}</span>
                </div>`;
            }).join('');
        }
        
        window.toggleEventPill = (eventId) => {
            if (activeEventTypes.has(eventId)) {
                activeEventTypes.delete(eventId);
            } else {
                activeEventTypes.add(eventId);
            }
            // Update visual
            const pill = document.querySelector(`[data-event-id="${eventId}"]`);
            if (pill) pill.classList.toggle('active');
            // Re-render calendar if data exists
            if (calendarData.length > 0) {
                renderCalendarMonth();
            }
        };
        
        window.generateEventCalendar = () => {
            if (!calendarNatalData || !calendarBirthDate) {
                alert('Please generate your horoscope first.');
                return;
            }
            
            const startDateEl = document.getElementById('calendarStartDate');
            const endDateEl = document.getElementById('calendarEndDate');
            
            const startDate = startDateEl.value ? new Date(startDateEl.value) : new Date();
            const endDate = endDateEl.value ? new Date(endDateEl.value) : new Date(startDate.getTime() + 90 * 24 * 60 * 60 * 1000);
            
            const days = Math.ceil((endDate - startDate) / (24 * 60 * 60 * 1000)) + 1;
            
            // Build house significators from natal data
            kpEventEngine.buildHouseSignificators(calendarNatalData.planets, calendarNatalData.kpCusps);
            
            // Generate calendar
            calendarData = kpEventEngine.generateCalendar(
                calendarMoonLong,
                calendarBirthDate,
                calendarNatalData.planets,
                calendarNatalData.kpCusps,
                startDate,
                Math.min(days, 365), // Cap at 1 year
                null // All event types for data, filter in render
            );
            
            currentCalendarMonth = new Date(startDate);
            renderCalendarMonth();
            
            // Show current day's dasha
            const todayData = calendarData.find(d => d.date === new Date().toISOString().split('T')[0]);
            if (todayData) {
                renderCurrentDasha(todayData.dasha);
            }
        };
        
        function renderCalendarMonth() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            
            // Clear existing day cells (keep headers)
            const headers = Array.from(grid.querySelectorAll('.calendar-header'));
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h));
            
            // Get month boundaries
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay(); // 0 = Sun
            
            // Update title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const dayNamesShort = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            document.getElementById('calendar-month-title').textContent = `${monthNames[month]} ${year}`;
            
            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-cell empty';
                grid.appendChild(emptyCell);
            }
            
            // Day cells
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = calendarData.find(d => d.date === dateStr);
                
                // Determine Day Name for mobile view
                const currentDayOfWeekIdx = (startDayOfWeek + (day - 1)) % 7;
                const dayName = dayNamesShort[currentDayOfWeekIdx];
                
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                cell.dataset.date = dateStr;
                
                if (dayData) {
                    // Filter events by active types and get max score
                    const activeEvents = dayData.events.filter(e => activeEventTypes.has(e.type));
                    const maxScore = activeEvents.length > 0 ? Math.max(...activeEvents.map(e => e.score)) : 0;
                    const dominantEvent = activeEvents.length > 0 ? activeEvents.reduce((a, b) => a.score > b.score ? a : b) : null;
                    
                    // Apply probability class
                    if (maxScore >= 70) cell.classList.add('prob-high');
                    else if (maxScore >= 40) cell.classList.add('prob-medium');
                    else if (maxScore > 0) cell.classList.add('prob-low');
                    else cell.classList.add('prob-very-low');
                    
                    cell.innerHTML = `
                        <div class="day-num">
                            <span>${day}</span>
                            <span class="day-name-mobile">${dayName}</span>
                        </div>
                        ${dominantEvent && maxScore > 0 ? `
                            <div class="flex items-center gap-1">
                                <span class="text-lg">${dominantEvent.icon}</span>
                                <span class="score-badge">${maxScore}%</span>
                            </div>
                        ` : ''}
                    `;
                    
                    cell.onclick = () => openDayModal(dayData, dayName);
                } else {
                    cell.classList.add('prob-very-low');
                    cell.innerHTML = `
                        <div class="day-num">
                            <span>${day}</span>
                            <span class="day-name-mobile">${dayName}</span>
                        </div>`;
                }
                
                grid.appendChild(cell);
            }
        }
        
        window.changeCalendarMonth = (delta) => {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
            renderCalendarMonth();
        };
        
        function renderCurrentDasha(dasha) {
            const container = document.getElementById('current-dasha-lords');
            if (!container) return;
            
            container.innerHTML = `
                <div class="flex items-center gap-1">
                    <span class="text-xs text-gray-400">MD:</span>
                    <span class="badge badge-primary">${dasha.mahadasha}</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-xs text-gray-400">AD:</span>
                    <span class="badge badge-secondary">${dasha.antardasha}</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-xs text-gray-400">PD:</span>
                    <span class="badge badge-accent">${dasha.pratyantar}</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-xs text-gray-400">SD:</span>
                    <span class="badge badge-ghost">${dasha.sookshma}</span>
                </div>
            `;
        }
        
        function openDayModal(dayData, dayName) {
            const backdrop = document.getElementById('day-modal-backdrop');
            const dateTitle = document.getElementById('modal-date-title');
            const dashaChain = document.getElementById('modal-dasha-chain');
            const eventsList = document.getElementById('modal-events-list');
            
            // Set date title
            const dateObj = new Date(dayData.date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            dateTitle.textContent = formattedDate;
            
            // Dasha chain
            dashaChain.innerHTML = `
                <div class="stat place-items-center">
                    <div class="stat-title text-xs">Mahadasha</div>
                    <div class="stat-value text-lg text-primary">${dayData.dasha.mahadasha}</div>
                </div>
                <div class="stat place-items-center">
                    <div class="stat-title text-xs">Antardasha</div>
                    <div class="stat-value text-lg text-secondary">${dayData.dasha.antardasha}</div>
                </div>
                <div class="stat place-items-center">
                    <div class="stat-title text-xs">Pratyantar</div>
                    <div class="stat-value text-lg text-accent">${dayData.dasha.pratyantar}</div>
                </div>
                <div class="stat place-items-center">
                    <div class="stat-title text-xs">Sookshma</div>
                    <div class="stat-value text-lg">${dayData.dasha.sookshma}</div>
                </div>
            `;
            
            // Active events with reasoning
            const activeEvents = dayData.events
                .filter(e => activeEventTypes.has(e.type) && e.score > 0)
                .sort((a, b) => b.score - a.score);
                
            if (activeEvents.length > 0) {
                eventsList.innerHTML = activeEvents.map(e => `
                    <div class="p-4 bg-base-200 rounded-lg mb-4">
                        <div class="flex items-center justify-between mb-3 border-b border-base-300 pb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${e.icon}</span>
                                <span class="font-bold text-lg">${e.name}</span>
                            </div>
                            <div class="badge ${e.score >= 70 ? 'badge-success' : (e.score >= 40 ? 'badge-warning' : 'badge-ghost')} text-white font-bold p-3">
                                ${e.score}% ${e.score >= 70 ? 'High' : (e.score >= 40 ? 'Medium' : 'Low')}
                            </div>
                        </div>
                        
                        <div class="text-sm opacity-80 mb-2 font-semibold">Contributing Factors (Why?):</div>
                        <div class="space-y-2">
                            ${e.contributors && e.contributors.length > 0 ? e.contributors.map(c => `
                                <div class="contributor-item flex justify-between items-center">
                                    <div>
                                        <div class="contributor-level">${c.level === 'bonus' ? '‚ú® Synergy Bonus' : (c.level === 'transit' ? 'ü™ê Transit Trigger' : c.level)}</div>
                                        <div class="text-xs opacity-70">
                                            ${c.level === 'bonus' 
                                                ? 'All dasha lords signify event houses' 
                                                : `${c.lord} signifies houses ${c.matched.join(', ')}`}
                                        </div>
                                    </div>
                                    <div class="font-mono font-bold text-success">+${c.points}%</div>
                                </div>
                            `).join('') : '<div class="text-xs opacity-50 italic">No direct significators found.</div>'}
                        </div>
                    </div>
                `).join('');
            } else {
                eventsList.innerHTML = `
                    <div class="text-center py-8 opacity-50">
                        <div class="text-4xl mb-2">üò¥</div>
                        <div>No significant events predicted for this day based on selected filters.</div>
                    </div>
                `;
            }
            
            // Show modal
            backdrop.classList.remove('hidden');
        }
        
        window.closeDayModal = () => {
            document.getElementById('day-modal-backdrop').classList.add('hidden');
        };

        // Initialize theme on page load
        (function initTheme() {
            const storedTheme = getStoredTheme();
            setTheme(storedTheme);
        })();
    </script>
</body>
</html>