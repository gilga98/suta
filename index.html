<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S≈™TA</title>
    <!-- Fonts: Outfit for Modern Look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tom Select -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <!-- Pako (GZIP Decompression) -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <!-- D3.js for Interactive Charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        primary: '#ff385c', // Airbnb Red-ish
                        secondary: '#222222', // Airbnb Dark
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Outfit', sans-serif; }
        [data-theme="light"] body { background-color: #f7f7f7; }
        [data-theme="dark"] body { background-color: #0f0f1a; }
        
        /* Dark mode overrides for cards and containers */
        [data-theme="dark"] .card { background-color: #1a1a2e !important; border-color: #2d2d44 !important; }
        [data-theme="dark"] .bg-base-100 { background-color: #1a1a2e !important; }
        [data-theme="dark"] .bg-gray-50 { background-color: #16162a !important; }
        [data-theme="dark"] .bg-gray-100 { background-color: #1f1f35 !important; }
        [data-theme="dark"] .border-gray-100 { border-color: #2d2d44 !important; }
        [data-theme="dark"] .border-gray-200 { border-color: #3d3d55 !important; }
        
        /* Dark mode text colors */
        [data-theme="dark"] .text-gray-400 { color: #9ca3af !important; }
        [data-theme="dark"] .text-gray-500 { color: #9ca3af !important; }
        [data-theme="dark"] .text-gray-600 { color: #d1d5db !important; }
        [data-theme="dark"] .text-gray-700 { color: #e5e7eb !important; }
        [data-theme="dark"] .text-gray-800 { color: #f3f4f6 !important; }
        [data-theme="dark"] .text-secondary { color: #e5e7eb !important; }
        
        /* Dark mode inputs */
        [data-theme="dark"] .input { background-color: #0f0f1a !important; border-color: #3d3d55 !important; color: #e5e7eb !important; }
        [data-theme="dark"] .input:focus { border-color: #ff385c !important; }
        [data-theme="dark"] .select { background-color: #0f0f1a !important; border-color: #3d3d55 !important; color: #e5e7eb !important; }
        
        /* Dark mode navbar */
        [data-theme="dark"] nav { background-color: #1a1a2e !important; border-color: #2d2d44 !important; }
        
        /* Dark mode tables */
        [data-theme="dark"] .table { color: #e5e7eb; }
        [data-theme="dark"] .table tr { border-color: #2d2d44 !important; }
        [data-theme="dark"] .table th { background-color: #16162a !important; color: #9ca3af !important; }
        [data-theme="dark"] .table-zebra tbody tr:nth-child(even) { background-color: #16162a !important; }
        [data-theme="dark"] .table tr:hover, [data-theme="dark"] .hover\\:bg-gray-50:hover { background-color: #232340 !important; }
        
        /* Dark mode badges and buttons */
        [data-theme="dark"] .badge { border-color: #3d3d55 !important; }
        [data-theme="dark"] .btn-ghost { color: #e5e7eb !important; }
        [data-theme="dark"] .btn-ghost:hover { background-color: #2d2d44 !important; }
        [data-theme="dark"] .btn-outline { border-color: #3d3d55 !important; color: #e5e7eb !important; }
        
        /* Dark mode tabs */
        [data-theme="dark"] .tabs-boxed { background-color: #16162a !important; }
        [data-theme="dark"] .tab { color: #9ca3af !important; }
        [data-theme="dark"] .tab-active { background-color: #2d2d44 !important; color: #fff !important; }
        
        /* Dark mode dropdown */
        [data-theme="dark"] .dropdown-content { background-color: #1a1a2e !important; border-color: #2d2d44 !important; }
        [data-theme="dark"] .dropdown-content li:hover { background-color: #232340 !important; }
        
        /* Dark mode collapse/accordion */
        [data-theme="dark"] .collapse { background-color: #16162a !important; border-color: #2d2d44 !important; }
        [data-theme="dark"] .collapse-title { color: #9ca3af !important; }
        
        /* Dark mode divider */
        [data-theme="dark"] .divider:before, [data-theme="dark"] .divider:after { background-color: #2d2d44 !important; }
        
        /* Dark mode chart elements */
        [data-theme="dark"] .chart-grid { background: #2d2d44; border-color: #4a4a6a; box-shadow: 0 4px 20px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.05); }
        [data-theme="dark"] .chart-cell { background: #1a1a2e; border-color: #3d3d55; }
        [data-theme="dark"] .chart-cell:hover { border-color: #ff6b8a; box-shadow: inset 0 0 12px rgba(255,107,138,0.2); }
        [data-theme="dark"] .chart-center { background: linear-gradient(135deg, #0f0f1a 0%, #16162a 100%); border-color: #3d3d55; }
        [data-theme="dark"] .rashi-label { color: #9ca3af; background: rgba(255,255,255,0.05); }
        [data-theme="dark"] .house-label { color: #ff6b8a; background: rgba(255,107,138,0.15); }
        [data-theme="dark"] .planet-glyph { background: rgba(0,0,0,0.6); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        
        /* Dark mode legend */
        [data-theme="dark"] .legend-swatch { border-color: rgba(255,255,255,0.2) !important; }
        
        /* Rashi colors in dark mode - slightly muted */
        [data-theme="dark"] .rashi-sun { background: linear-gradient(135deg, #78350f 0%, #451a03 100%); }
        [data-theme="dark"] .rashi-moon { background: linear-gradient(135deg, #374151 0%, #1f2937 100%); }
        [data-theme="dark"] .rashi-mars { background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%); }
        [data-theme="dark"] .rashi-mercury { background: linear-gradient(135deg, #064e3b 0%, #022c22 100%); }
        [data-theme="dark"] .rashi-jupiter { background: linear-gradient(135deg, #713f12 0%, #422006 100%); }
        [data-theme="dark"] .rashi-venus { background: linear-gradient(135deg, #581c87 0%, #3b0764 100%); }
        [data-theme="dark"] .rashi-saturn { background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%); }
        /* ====== KUNDALI CHART STYLES (REDESIGNED) ====== */
        .chart-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(4, 70px); 
            gap: 0; 
            border: 3px solid #374151; 
            width: 100%; 
            aspect-ratio: 1; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.12), inset 0 0 0 1px rgba(255,255,255,0.1);
        }
        .chart-cell { 
            background: white; 
            position: relative; 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.70rem; 
            padding: 4px; 
            transition: all 0.2s ease; 
            border: 2px solid #d1d5db;
            cursor: pointer;
        }
        .chart-cell:hover { 
            filter: brightness(0.95); 
            border-color: #ff385c;
            box-shadow: inset 0 0 12px rgba(255,56,92,0.15);
            z-index: 5;
        }
        .chart-center { 
            grid-column: 2 / span 2; 
            grid-row: 2 / span 2; 
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            border: 2px solid #e5e7eb;
            cursor: default;
        }
        .chart-center:hover { border-color: #e5e7eb; box-shadow: none; }
        .planet-glyph { font-weight: 600; margin: 2px; padding: 3px 6px; border-radius: 6px; font-size: 0.75rem; background: rgba(255,255,255,0.9); box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .planet-Ascendant { color: #ff385c; background: rgba(255,241,242,0.95); font-weight: 700; }
        .planet-Sun { color: #f59e0b; } /* Bright Amber */
        .planet-Moon { color: #0ea5e9; } /* Sky Blue */
        .planet-Mars { color: #dc2626; } /* Red */
        .planet-Mercury { color: #22c55e; } /* Green */
        .planet-Jupiter { color: #ca8a04; } /* Dark Yellow - distinct from Sun */
        .planet-Venus { color: #ec4899; } /* Pink */
        .planet-Saturn { color: #6366f1; } /* Indigo */
        .planet-Rahu { color: #8b5cf6; } /* Purple */
        .planet-Ketu { color: #a855f7; } /* Light Purple */
        
        /* Dark mode planet colors - brighter for visibility */
        [data-theme="dark"] .planet-Sun { color: #fbbf24; }
        [data-theme="dark"] .planet-Moon { color: #38bdf8; }
        [data-theme="dark"] .planet-Mars { color: #f87171; }
        [data-theme="dark"] .planet-Mercury { color: #4ade80; }
        [data-theme="dark"] .planet-Jupiter { color: #facc15; }
        [data-theme="dark"] .planet-Venus { color: #f472b6; }
        [data-theme="dark"] .planet-Saturn { color: #818cf8; }
        [data-theme="dark"] .planet-Rahu { color: #a78bfa; }
        [data-theme="dark"] .planet-Ketu { color: #c084fc; }
        [data-theme="dark"] .planet-Ascendant { background: rgba(255,56,92,0.2); }
        
        /* Rashi Lord Color Backgrounds */
        .rashi-sun { background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); } /* Orange tint for Leo */
        .rashi-moon { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); } /* Silver for Cancer */
        .rashi-mars { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); } /* Red tint for Aries, Scorpio */
        .rashi-mercury { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); } /* Green for Gemini, Virgo */
        .rashi-jupiter { background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); } /* Yellow for Sagittarius, Pisces */
        .rashi-venus { background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); } /* Pink for Taurus, Libra */
        .rashi-saturn { background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%); } /* Blue tint for Capricorn, Aquarius */
        
        /* Enhanced Labels */
        .rashi-label { 
            position: absolute; 
            bottom: 2px; 
            right: 4px; 
            font-size: 8px; 
            font-weight: 600; 
            opacity: 0.8; 
            text-transform: uppercase; 
            letter-spacing: 0.02em; 
            background: rgba(0,0,0,0.05);
            padding: 1px 4px;
            border-radius: 3px;
        }
        .house-label { 
            position: absolute; 
            top: 2px; 
            left: 4px; 
            font-size: 11px; 
            font-weight: 800; 
            color: #ff385c; 
            background: rgba(255,56,92,0.1);
            padding: 2px 5px;
            border-radius: 4px;
        }
        
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 50; display: flex; justify-content: center; align-items: center; }
        #loader.hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        
        /* Custom Scrollbar for tables */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Input Transitions */
        .input-group:focus-within label { color: #ff385c; }

        /* Input Transitions */
        .input-group:focus-within label { color: #ff385c; }
        
        /* Legend Styling */
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 10px; }
        .legend-swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); }
        
        /* Mobile tab content: hidden by default on mobile, always visible on desktop */
        @media (max-width: 1023px) {
            .mobile-tab-content:not(.active) { display: none !important; }
        }
        /* No desktop rule needed - let default styles/Tailwind classes apply */
        
        /* Dasha expansion arrow transition */
        .dasha-arrow { transition: transform 0.2s ease; }
        
        /* ====== EVENT CALENDAR STYLES ====== */
        
        /* Event Type Pills */
        .event-pill { 
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            padding: 8px 14px; 
            border-radius: 24px; 
            border: 2px solid #e5e7eb; 
            background: white; 
            font-size: 13px; 
            font-weight: 500;
            cursor: pointer; 
            transition: all 0.2s ease;
            user-select: none;
        }
        .event-pill:hover { border-color: #ff385c; transform: translateY(-1px); }
        .event-pill.active { 
            background: linear-gradient(135deg, #ff385c 0%, #ff6b8a 100%); 
            border-color: #ff385c; 
            color: white; 
            box-shadow: 0 4px 12px rgba(255, 56, 92, 0.3);
        }
        .event-pill .pill-icon { font-size: 16px; }
        
        [data-theme="dark"] .event-pill { background: #1a1a2e; border-color: #3d3d55; color: #e5e7eb; }
        [data-theme="dark"] .event-pill:hover { border-color: #ff6b8a; }
        [data-theme="dark"] .event-pill.active { background: linear-gradient(135deg, #ff385c 0%, #ff6b8a 100%); color: white; }
        
        /* Calendar CSS */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        
        .calendar-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-base-content);
            opacity: 0.7;
            padding: 0.5rem 0;
        }
        
        .calendar-cell {
            aspect-ratio: 1;
            border-radius: 0.5rem;
            padding: 0.25rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
         
        /* Mobile List View for Calendar */
        @media (max-width: 640px) {
            .calendar-container {
                padding: 0.5rem;
            }
            
            .calendar-grid {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .calendar-header {
                display: none; /* Hide Sun, Mon... headers on mobile */
            }
            
            .calendar-cell {
                aspect-ratio: auto; /* Remove square aspect ratio */
                flex-direction: row; /* Horizontal layout */
                justify-content: space-between;
                align-items: center;
                padding: 1rem;
                background-color: var(--color-base-200); /* Card look */
                border: 1px solid var(--color-base-300);
            }
            
            .calendar-cell.empty {
                display: none; /* Hide empty filler cells */
            }
            
            .day-num {
                font-size: 1.1rem;
                font-weight: 700;
                display: flex;
                flex-direction: column;
            }
            
            .day-name-mobile {
                font-size: 0.75rem;
                font-weight: normal;
                opacity: 0.7;
                display: block !important;
            }

            .score-badge {
                font-size: 0.9rem !important;
                padding: 0.25rem 0.75rem !important;
            }
        }
        
        .day-name-mobile {
            display: none; /* Hidden on desktop */
        }
        
        /* Today highlight */
        .calendar-cell.today {
            border: 2px solid #ff385c !important;
            box-shadow: 0 0 0 3px rgba(255, 56, 92, 0.2);
        }
        
        .calendar-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .calendar-cell.today:hover {
            box-shadow: 0 0 0 3px rgba(255, 56, 92, 0.3), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .day-num {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .score-badge {
            font-size: 0.7rem;
            padding: 0.1rem 0.3rem;
            border-radius: 9999px;
            color: white;
            font-weight: 700;
            margin-top: 0.25rem;
        }
        
        /* Probability Colors */
        .prob-high { background-color: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.3); }
        .prob-high .score-badge { background-color: #16a34a; }
        
        .prob-medium { background-color: rgba(234, 179, 8, 0.15); border-color: rgba(234, 179, 8, 0.3); }
        .prob-medium .score-badge { background-color: #ca8a04; }
        
        .prob-low { background-color: rgba(249, 115, 22, 0.15); border-color: rgba(249, 115, 22, 0.3); }
        .prob-low .score-badge { background-color: #ea580c; }
        
        .prob-very-low { background-color: rgba(100, 116, 139, 0.1); border-color: rgba(100, 116, 139, 0.2); }
        .prob-very-low .score-badge { display: none; } /* Hide score 0 */

        /* Contributors List in Modal */
        .contributor-item {
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--color-base-200);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .contributor-level {
            text-transform: capitalize;
            font-weight: 600;
            color: var(--color-primary);
        }
        
        [data-theme="dark"] .prob-high { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); color: #fecaca; border-color: #b91c1c; }
        [data-theme="dark"] .prob-medium { background: linear-gradient(135deg, #78350f 0%, #92400e 100%); color: #fde68a; border-color: #b45309; }
        [data-theme="dark"] .prob-low { background: linear-gradient(135deg, #064e3b 0%, #065f46 100%); color: #a7f3d0; border-color: #059669; }
        [data-theme="dark"] .prob-very-low { background: #1f1f35; color: #9ca3af; }
        
        /* Month Navigation */
        .month-nav { display: flex; align-items: center; justify-content: space-between; }
        .month-nav .month-title { font-size: 1.25rem; font-weight: 700; }
        
        /* Day Modal */
        .day-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; }
        .day-modal-backdrop.active { opacity: 1; pointer-events: auto; }
        .day-modal { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25); transform: scale(0.9); transition: transform 0.2s ease; }
        .day-modal-backdrop.active .day-modal { transform: scale(1); }
        [data-theme="dark"] .day-modal { background: #1a1a2e; }
        
        /* ====== CHART STYLES (HEATMAP REDESIGN) ====== */
        
        /* Summary Cards Grid */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-card {
            padding: 1rem;
            border-radius: 12px;
            background: white;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .summary-card:hover {
            border-color: #ff385c;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .summary-card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .summary-card-icon { font-size: 1rem; }
        
        .summary-card-sparkline {
            height: 32px;
            margin: 0.5rem 0;
        }
        
        .summary-card-sparkline svg { width: 100%; height: 100%; }
        
        .summary-card-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: #94a3b8;
        }
        
        .summary-card-peak {
            font-weight: 600;
            color: #22c55e;
        }
        
        [data-theme="dark"] .summary-card {
            background: #1a1a2e;
            border-color: #3d3d55;
        }
        
        [data-theme="dark"] .summary-card-header { color: #9ca3af; }
        [data-theme="dark"] .summary-card-stats { color: #6b7280; }
        
        /* Timeframe Selector Buttons */
        .timeframe-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .timeframe-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            background: white;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .timeframe-btn:hover {
            border-color: #ff385c;
            transform: translateY(-1px);
        }
        
        .timeframe-btn.active {
            background: linear-gradient(135deg, #ff385c 0%, #ff6b8a 100%);
            border-color: #ff385c;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 56, 92, 0.3);
        }
        
        [data-theme="dark"] .timeframe-btn {
            background: #16162a;
            border-color: #3d3d55;
            color: #e5e7eb;
        }
        
        [data-theme="dark"] .timeframe-btn:hover { border-color: #ff6b8a; }
        [data-theme="dark"] .timeframe-btn.active { background: linear-gradient(135deg, #ff385c 0%, #ff6b8a 100%); color: white; }
        
        /* Heatmap Container */
        .heatmap-wrapper {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        [data-theme="dark"] .heatmap-wrapper {
            background: #1a1a2e;
            border-color: #3d3d55;
        }
        
        .heatmap-container {
            display: flex;
            gap: 0.5rem;
            overflow: hidden;
        }
        
        .heatmap-y-axis {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 3px;
            padding-top: 24px; /* Align with grid */
        }
        
        .heatmap-y-label {
            height: 24px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #64748b;
            white-space: nowrap;
        }
        
        .heatmap-y-label-icon { font-size: 12px; }
        
        [data-theme="dark"] .heatmap-y-label { color: #9ca3af; }
        
        .heatmap-scroll {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 8px;
        }
        
        .heatmap-x-axis {
            display: flex;
            gap: 3px;
            margin-bottom: 4px;
            height: 20px;
        }
        
        .heatmap-x-label {
            font-size: 9px;
            color: #94a3b8;
            text-align: center;
            flex-shrink: 0;
        }
        
        [data-theme="dark"] .heatmap-x-label { color: #6b7280; }
        
        .heatmap-grid {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .heatmap-row {
            display: flex;
            gap: 3px;
        }
        
        .heatmap-cell {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            flex-shrink: 0;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.3);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Probability color scale */
        .heatmap-cell.prob-0 { background: #f1f5f9; }
        .heatmap-cell.prob-1 { background: #fef3c7; }
        .heatmap-cell.prob-2 { background: #fde68a; }
        .heatmap-cell.prob-3 { background: #fcd34d; }
        .heatmap-cell.prob-4 { background: #a3e635; }
        .heatmap-cell.prob-5 { background: #4ade80; }
        .heatmap-cell.prob-6 { background: #22c55e; }
        .heatmap-cell.prob-7 { background: #16a34a; }
        
        [data-theme="dark"] .heatmap-cell.prob-0 { background: #1e293b; }
        [data-theme="dark"] .heatmap-cell.prob-1 { background: #422006; }
        [data-theme="dark"] .heatmap-cell.prob-2 { background: #713f12; }
        [data-theme="dark"] .heatmap-cell.prob-3 { background: #a16207; }
        [data-theme="dark"] .heatmap-cell.prob-4 { background: #65a30d; }
        [data-theme="dark"] .heatmap-cell.prob-5 { background: #15803d; }
        [data-theme="dark"] .heatmap-cell.prob-6 { background: #166534; }
        [data-theme="dark"] .heatmap-cell.prob-7 { background: #14532d; }
        
        /* Heatmap Legend */
        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 11px;
            color: #64748b;
        }
        
        .heatmap-legend-gradient {
            width: 120px;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, #f1f5f9, #fde68a, #4ade80, #16a34a);
        }
        
        [data-theme="dark"] .heatmap-legend { color: #9ca3af; }
        [data-theme="dark"] .heatmap-legend-gradient {
            background: linear-gradient(to right, #1e293b, #713f12, #15803d, #14532d);
        }
        
        /* Tooltip */
        .heatmap-tooltip {
            position: fixed;
            z-index: 1000;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .heatmap-tooltip.visible { opacity: 1; }
        
        [data-theme="dark"] .heatmap-tooltip {
            background: #1a1a2e;
            border-color: #3d3d55;
            color: #e5e7eb;
        }
        
        /* Chart View Toggle Tabs */
        .chart-calendar-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .chart-tab {
            flex: 1;
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .chart-tab:hover { border-color: #ff385c; }
        
        .chart-tab.active {
            background: linear-gradient(135deg, #ff385c 0%, #ff6b8a 100%);
            border-color: #ff385c;
            color: white;
        }
        
        [data-theme="dark"] .chart-tab { background: #16162a; border-color: #3d3d55; color: #e5e7eb; }
        [data-theme="dark"] .chart-tab.active { background: linear-gradient(135deg, #ff385c 0%, #ff6b8a 100%); color: white; }
        
        /* Chart/Calendar Content Containers */
        .chart-view-content, .calendar-view-content { display: none; }
        .chart-view-content.active, .calendar-view-content.active { display: block; }
        
        /* Mobile Responsive */
        @media (max-width: 640px) {
            .summary-cards { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .summary-card { padding: 0.75rem; }
            .heatmap-cell { width: 20px; height: 20px; }
            .heatmap-y-label { font-size: 10px; }
            .timeframe-btn { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
        }
    </style>
</head>
<body class="text-secondary antialiased min-h-screen flex flex-col">

    <!-- LOADER -->
    <div id="loader">
        <div class="flex flex-col items-center gap-4">
            <span class="loading loading-dots loading-lg text-primary"></span>
            <div class="text-center">
                <h3 class="text-xl font-bold tracking-tight">S≈™TA</h3>
                <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest">Loading Ephemeris Data</p>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-base-100 border-b border-gray-100 sticky top-0 z-40 transform transition-all duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üïâÔ∏è</span>
                <span class="font-bold text-lg tracking-tight">S≈™TA</span>
            </div>
            <div class="flex items-center gap-2">
               <!-- Profiles Dropdown -->
               <div class="dropdown dropdown-end">
                  <label tabindex="0" class="btn btn-ghost btn-sm gap-1">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                     <span class="text-xs font-medium hidden sm:inline">Profiles</span>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </label>
                  <div tabindex="0" class="dropdown-content z-50 menu p-3 shadow-xl bg-base-100 rounded-xl w-72 border border-gray-100">
                     <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 px-2">Saved Profiles</div>
                     <ul id="profilesList" class="max-h-48 overflow-y-auto custom-scroll">
                        <li class="text-gray-400 text-xs px-2 py-2">No saved profiles</li>
                     </ul>
                     <div class="divider my-2"></div>
                     <button onclick="saveCurrentProfile()" class="btn btn-primary btn-sm w-full gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                        Save Current
                     </button>
                  </div>
               </div>
               <button id="themeToggle" onclick="toggleTheme()" class="btn btn-ghost btn-circle btn-sm">
                  <!-- Sun icon for light mode -->
                  <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                  <!-- Moon icon for dark mode -->
                  <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
               </button>
            </div>
        </div>
    </nav>

    <!-- CONTENT WRAPPER -->
    <main class="flex-grow p-4 sm:p-6 lg:p-8 w-full max-w-7xl mx-auto flex flex-col gap-8">

        <!-- INPUT SECTION (HERO) -->
        <section id="input-section" class="w-full transition-all duration-500 ease-in-out mx-auto max-w-3xl">
            <div class="card bg-base-100 shadow-xl rounded-2xl overflow-hidden border border-gray-100">
                <div class="card-body p-6 sm:p-8">
                    <div class="text-center mb-6">
                        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-pink-600">Enter Birth Details</h1>
                        <p class="text-gray-500 text-sm mt-1">Accurate calculations span 5000+ years</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Left Col: Basics -->
                        <div class="space-y-4">
                            <div class="form-control w-full input-group">
                                <label class="label pb-1"><span class="label-text text-xs font-bold uppercase text-gray-400 tracking-wider">Name</span></label>
                                <input type="text" id="name" placeholder="Name" class="input input-bordered w-full rounded-xl focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all" />
                            </div>
                            
                            <div class="form-control w-full input-group">
                                <label class="label pb-1"><span class="label-text text-xs font-bold uppercase text-gray-400 tracking-wider">Date of Birth</span></label>
                                <input type="date" id="dob" class="input input-bordered w-full rounded-xl focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all text-gray-700" />
                            </div>

                            <div class="form-control w-full input-group">
                                <label class="label pb-1"><span class="label-text text-xs font-bold uppercase text-gray-400 tracking-wider">Time of Birth</span></label>
                                <input type="time" id="tob" step="1" class="input input-bordered w-full rounded-xl focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all text-gray-700" />
                            </div>
                        </div>

                        <!-- Right Col: Location & Settings -->
                        <div class="space-y-4">
                             <div class="form-control w-full">
                                <label class="label pb-1"><span class="label-text text-xs font-bold uppercase text-gray-400 tracking-wider">Place of Birth</span></label>
                                <select id="citySelect" class="w-full" placeholder="Search City..." autocomplete="off">
                                    <option value="">Search City...</option>
                                </select>
                                <!-- HIDDEN FIELDS AUTO-POPULATED -->
                                <input type="hidden" id="selectedLat">
                                <input type="hidden" id="selectedLng">
                                <input type="hidden" id="timezone">
                            </div>
                            
                            <!-- Expandable Settings -->
                            <div class="collapse collapse-arrow border border-gray-100 rounded-xl bg-gray-50 mt-2">
                                <input type="checkbox" /> 
                                <div class="collapse-title text-xs font-bold text-gray-500">Advanced Settings</div>
                                <div class="collapse-content space-y-3"> 
                                    <div>
                                        <label class="label py-1"><span class="label-text text-xs">Ayanamsa</span></label>
                                        <select id="ayaMode" class="select select-bordered select-xs w-full rounded-lg">
                                            <option value="27">True Chitrapaksha</option>
                                            <option value="1" selected>Lahiri (Traditional)</option>
                                            <option value="5">KP (Krishnamurti)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label py-1"><span class="label-text text-xs">Positions</span></label>
                                        <select id="calcMode" class="select select-bordered select-xs w-full rounded-lg">
                                            <option value="16" selected>True Geometric</option>
                                            <option value="0">Apparent</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <button id="calcBtn" onclick="generateChart()" class="btn btn-primary w-full rounded-xl text-white text-lg font-normal tracking-wide shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all" disabled>
                            Generate Horoscope
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- OUTPUT SECTION (DASHBOARD) -->
        <section id="output" class="hidden w-full transition-opacity duration-700 opacity-0">
            
             <!-- MOBILE TAB BAR -->
             <div class="lg:hidden mb-4">
                 <div role="tablist" class="tabs tabs-boxed bg-gray-100 p-1 rounded-xl">
                     <a role="tab" class="tab tab-active rounded-lg transition-all mobile-tab" data-tab="chart" onclick="switchMobileTab('chart', this)">Chart</a>
                     <a role="tab" class="tab rounded-lg transition-all mobile-tab" data-tab="panchang" onclick="switchMobileTab('panchang', this)">Panchang</a>
                     <a role="tab" class="tab rounded-lg transition-all mobile-tab" data-tab="details" onclick="switchMobileTab('details', this)">Details</a>
                 </div>
             </div>

             <!-- DASHBOARD GRID -->
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                 
                <!-- LEFT COLUMN: CHARTS (Sticky on Desktop) -->
                <div class="lg:col-span-4 flex flex-col gap-6 lg:sticky lg:top-24 self-start">
                    <!-- CHART CARD (mobile-tab-content) -->
                    <div id="mobile-content-chart" class="mobile-tab-content active card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-4">
                         <div role="tablist" class="tabs tabs-boxed bg-gray-100 p-1 rounded-xl mb-4">
                             <a role="tab" class="tab tab-active rounded-lg transition-all" onclick="switchChartTab('d1', this)">Rashi (D1)</a>
                             <a role="tab" class="tab rounded-lg transition-all" onclick="switchChartTab('d9', this)">Navamsa</a>
                         </div>
                         
                         <div id="chart-container-d1" class="chart-view">
                             <div class="chart-grid" id="chart-d1"></div>
                         </div>
                         <div id="chart-container-d9" class="chart-view hidden">
                             <div class="chart-grid" id="chart-d9"></div>
                         </div>
                         
                         <!-- Rashi Legend -->
                         <div class="mt-4 p-3 bg-gray-50 rounded-xl border border-gray-100">
                             <div class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-2">Rashi Lords</div>
                             <div class="grid grid-cols-4 gap-2">
                                 <div class="legend-item"><div class="legend-swatch rashi-sun"></div><span class="text-gray-600">‚òâ Sun</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-moon"></div><span class="text-gray-600">‚òΩ Moon</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-mars"></div><span class="text-gray-600">‚ôÇ Mars</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-mercury"></div><span class="text-gray-600">‚òø Mercury</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-jupiter"></div><span class="text-gray-600">‚ôÉ Jupiter</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-venus"></div><span class="text-gray-600">‚ôÄ Venus</span></div>
                                 <div class="legend-item"><div class="legend-swatch rashi-saturn"></div><span class="text-gray-600">‚ôÑ Saturn</span></div>
                             </div>
                         </div>

                         <!-- Chart Stats -->
                         <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
                             <!-- Strongest Planet -->
                             <div class="p-2 bg-base-200 rounded-lg flex justify-between items-center col-span-2">
                                 <span class="opacity-70 font-semibold">Strongest (Shadbala)</span>
                                 <span class="font-bold badge badge-sm badge-warning text-white" id="stats-strongest">-</span>
                             </div>
                             
                              <!-- Aspect Toggle -->
                             <button onclick="toggleAspects()" class="btn btn-xs btn-outline btn-primary w-full col-span-2 mt-1 gap-2 group">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 group-hover:rotate-45 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                <span id="aspect-btn-text">Show Aspects</span>
                             </button>
                         </div>

                         <!-- Basic Vitals Below Chart -->
                         <div class="mt-4 flex justify-between items-center px-2">
                             <div class="text-center">
                                 <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">Lagna</div>
                                 <div class="text-xl font-medium text-primary" id="val-ascDesc">-</div>
                                 <div class="text-xs font-mono text-gray-500" id="val-ascDeg">-</div>
                             </div>
                             <div class="divider divider-horizontal mx-0"></div>
                             <div class="text-center">
                                 <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">Moon Sign</div>
                                 <div class="text-xl font-medium text-secondary" id="val-moonSign">-</div>
                                 <div class="text-xs text-gray-500" id="val-moonNak">-</div>
                             </div>
                         </div>
                     </div>

                     
                     <!-- PANCHANGA CARD (mobile-tab-content) -->
                     <div id="mobile-content-panchang" class="mobile-tab-content">
                     <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-4">
                         <h3 class="font-bold text-gray-800 mb-3 px-2">Panchanga</h3>
                         <div class="overflow-x-auto">
                             <table class="table table-sm text-xs">
                                 <tbody>
                                     <tr class="border-b border-gray-50">
                                         <td class="text-gray-400 font-medium">Tithi</td>
                                         <td class="font-semibold text-right" id="pan-tithi">-</td>
                                     </tr>
                                     <tr class="border-b border-gray-50">
                                         <td class="text-gray-400 font-medium">Vara</td>
                                         <td class="font-semibold text-right" id="pan-vara">-</td>
                                     </tr>
                                     <tr class="border-b border-gray-50">
                                         <td class="text-gray-400 font-medium">Nakshatra</td>
                                         <td class="font-semibold text-right" id="pan-nak">-</td>
                                     </tr>
                                     <tr class="border-b border-gray-50">
                                         <td class="text-gray-400 font-medium">Yoga</td>
                                         <td class="font-semibold text-right" id="pan-yoga">-</td>
                                     </tr>
                                     <tr>
                                         <td class="text-gray-400 font-medium">Karana</td>
                                         <td class="font-semibold text-right" id="pan-karana">-</td>
                                     </tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>
                     </div>
                 </div>

                     <!-- RIGHT COLUMN: DETAILED DATA (mobile-tab-content) -->
                 <div id="mobile-content-details" class="mobile-tab-content lg:col-span-8 flex flex-col gap-8">

                     
                     <!-- PLANETARY POSITIONS -->
                     <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-6">
                         <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-2">Planetary Positions</h3>
                         <div class="overflow-x-auto custom-scroll">
                             <table class="table w-full text-center">
                                 <thead>
                                     <tr class="bg-gray-50 text-gray-500 uppercase text-xs tracking-wider">
                                         <th class="rounded-l-lg py-4">Planet</th>
                                         <th class="py-4">Rashi</th>
                                         <th class="py-4">Degree</th>
                                         <th class="py-4">Nakshatra</th>
                                         <th class="py-4">Pada</th>
                                         <th class="py-4">Lord</th>
                                        <th class="py-4">Star Lord</th>
                                         <th class="rounded-r-lg py-4">Status</th>
                                     </tr>
                                 </thead>
                                 <tbody id="planet-detail-body" class="text-sm"></tbody>
                             </table>
                         </div>
                     </div>

                     <!-- DASHA & STRENGTH -->
                     <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-6">
                         <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-2">Dasha & Strength</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div>
                                 <h4 class="font-bold text-lg mb-4 text-gray-600">Vimshottari Dasha</h4>
                                 <div class="overflow-x-auto h-96 custom-scroll border border-gray-100 rounded-lg">
                                    <table class="table table-pin-rows table-zebra w-full">
                                        <thead><tr class="bg-gray-50 text-gray-500"><th>Lord</th><th>Start</th><th>End</th><th>Dur</th></tr></thead>
                                        <tbody id="dasha-body"></tbody>
                                    </table>
                                </div>
                             </div>
                             <div>
                                 <h4 class="font-bold text-lg mb-4 text-gray-600">Shadbala Strength</h4>
                                 <div class="overflow-x-auto h-96 custom-scroll border border-gray-100 rounded-lg">
                                    <table class="table table-pin-rows table-zebra w-full text-center">
                                        <thead><tr class="bg-gray-50 text-gray-500"><th>Planet</th><th>Total</th><th>Rel</th></tr></thead>
                                        <tbody id="shadbala-body"></tbody>
                                    </table>
                                </div>
                             </div>
                         </div>
                     </div>

                     <!-- KP SYSTEM -->
                     <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-6">
                        <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-2">KP System</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <div class="badge badge-primary badge-outline mb-3 font-medium">House Cusps</div>
                                <div class="overflow-x-auto max-h-96 custom-scroll border rounded-lg">
                                    <table class="table table-zebra table-pin-rows">
                                        <thead><tr class="bg-gray-50"><th>Cusp</th><th>Sign</th><th>Deg</th><th>SgnL</th><th>StrL</th><th>SubL</th></tr></thead>
                                        <tbody id="kp-cusp-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <div class="badge badge-secondary badge-outline mb-3 font-medium">Planetary Signification</div>
                                <div class="overflow-x-auto max-h-96 custom-scroll border rounded-lg">
                                    <table class="table table-zebra table-pin-rows">
                                        <thead><tr class="bg-gray-50"><th>Pl</th><th>Deg</th><th>SgnL</th><th>StrL</th><th>SubL</th></tr></thead>
                                        <tbody id="kp-planet-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ANALYSIS -->
                    <div class="card bg-base-100 shadow-lg rounded-2xl border border-gray-100 p-6">
                        <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-2">Detailed Analysis</h3>
                        <div class="space-y-8">
                            <!-- Doshas -->
                            <div class="p-6 bg-gray-50 rounded-xl border border-gray-100">
                                <h4 class="font-bold text-sm uppercase text-gray-400 mb-4 tracking-wider">Dosha Analysis</h4>
                                <div class="flex flex-wrap gap-4" id="dosha-container"></div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="font-bold text-lg mb-4 text-gray-600">Avkahada Chakra</h4>
                                    <table class="table border rounded-lg bg-base-100">
                                        <tbody id="avkahada-body"></tbody>
                                    </table>
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg mb-4 text-gray-600">Jaimini Karakas</h4>
                                    <table class="table border rounded-lg bg-base-100">
                                        <thead><tr class="bg-gray-50"><th>Karaka</th><th>Planet</th><th>Deg</th></tr></thead>
                                        <tbody id="jaimini-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                 </div>
             </div>
        </section>

         <!-- DATA & NARRATION SECTION -->
         <section id="data-export-section" class="w-full transition-all duration-500 ease-in-out hidden">
             <div class="card bg-base-100 shadow-xl rounded-2xl overflow-hidden border border-gray-100">
                 <div class="card-body p-6 sm:p-8">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                         <h2 class="text-2xl font-bold text-gray-800">Data & Narration</h2>
                         <div class="flex items-center gap-4">
                             <!-- Toggle -->
                             <label class="cursor-pointer label gap-2">
                                 <span class="label-text font-bold text-gray-500">JSON</span> 
                                 <input type="checkbox" class="toggle toggle-primary" id="viewToggle" onchange="toggleDataView()" checked />
                                 <span class="label-text font-bold text-gray-500">Verbal</span> 
                             </label>
                             <!-- Copy Button -->
                             <button class="btn btn-outline btn-sm gap-2" onclick="copyDataToClipboard()">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                                 Copy
                             </button>
                         </div>
                     </div>

                     <!-- Content Container -->
                     <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 relative max-h-[600px] overflow-y-auto custom-scroll">
                         <!-- JSON VIEW -->
                         <pre id="json-view" class="text-xs font-mono text-gray-700 whitespace-pre-wrap hidden"></pre>
                         <!-- VERBAL CONTENT VIEW -->
                         <div id="verbal-view" class="prose prose-sm max-w-none text-gray-700 leading-relaxed space-y-4"></div>
                     </div>
                 </div>
             </div>
         </section>

         <!-- EVENT CALENDAR SECTION -->
         <section id="event-calendar-section" class="w-full transition-all duration-500 ease-in-out hidden">
             <div class="card bg-base-100 shadow-xl rounded-2xl overflow-hidden border border-gray-100">
                 <div class="card-body p-6 sm:p-8">
                     
                     <!-- Header -->
                     <div class="flex flex-col gap-4 mb-6">
                         <div>
                             <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-pink-600">
                                 Event Probability Calendar
                             </h2>
                             <p class="text-gray-500 text-sm mt-1">KP System Analysis with Deep Dasha (Pratyantar ‚Üí Sookshma)</p>
                         </div>
                         
                        <!-- Date Range Controls Removed (Auto-generated) -->
                        <div class="hidden">
                            <!-- Inputs removed for redesign -->
                        </div>
                     </div>
                     
                     <!-- Event Type Pills (Search/Filter) -->
                     <div class="mb-6">
                         <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Select Event Types</div>
                         <div class="flex flex-wrap gap-2" id="event-pills-container">
                             <!-- Pills will be dynamically generated -->
                         </div>
                     </div>
                     
                     <!-- Chart/Calendar View Toggle -->
                     <div class="chart-calendar-tabs">
                         <button class="chart-tab active" onclick="switchCalendarView('chart')">
                             üìä Chart View
                         </button>
                         <button class="chart-tab" onclick="switchCalendarView('calendar')">
                             üìÖ Calendar View
                         </button>
                     </div>
                     
                     <!-- CHART VIEW CONTENT -->
                     <div class="chart-view-content active" id="chart-view">
                         
                         <!-- Timeframe Selector -->
                         <div class="timeframe-selector">
                             <button class="timeframe-btn" onclick="setChartTimeframe('1W')">1W</button>
                             <button class="timeframe-btn" onclick="setChartTimeframe('1M')">1M</button>
                             <button class="timeframe-btn active" onclick="setChartTimeframe('3M')">3M</button>
                             <button class="timeframe-btn" onclick="setChartTimeframe('6M')">6M</button>
                             <button class="timeframe-btn" onclick="setChartTimeframe('1Y')">1Y</button>
                             <button class="timeframe-btn" onclick="setChartTimeframe('ALL')">ALL</button>
                         </div>
                         
                         <!-- Summary Cards -->
                         <div class="summary-cards" id="summary-cards">
                             <!-- Dynamically populated -->
                         </div>
                        
                         <!-- Heatmap Container -->
                         <div class="heatmap-wrapper">
                             <div class="heatmap-container">
                                 <div class="heatmap-y-axis" id="heatmap-y-labels">
                                     <!-- Y-axis labels (event types) -->
                                 </div>
                                 <div class="heatmap-scroll" id="heatmap-scroll">
                                     <div class="heatmap-x-axis" id="heatmap-x-labels">
                                         <!-- X-axis labels (dates) -->
                                     </div>
                                     <div class="heatmap-grid" id="heatmap-grid">
                                         <!-- Grid cells -->
                                     </div>
                                 </div>
                             </div>
                             
                             <!-- Legend -->
                             <div class="heatmap-legend">
                                 <span>Low</span>
                                 <div class="heatmap-legend-gradient"></div>
                                 <span>High</span>
                             </div>
                         </div>
                         
                         <!-- Tooltip (positioned fixed) -->
                         <div class="heatmap-tooltip" id="heatmap-tooltip"></div>
                         
                         <!-- Help Text -->
                         <div class="text-xs text-gray-500 mt-4 px-2">
                             <strong>üí° Tip:</strong> Scroll horizontally to see more dates. Tap any cell to view details for that day.
                         </div>
                     </div>
                     
                     <!-- CALENDAR VIEW CONTENT -->
                     <div class="calendar-view-content" id="calendar-view">
                     
                     <!-- Probability Legend - Wrapping -->
                     <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4 px-2">
                         <span class="text-xs font-bold text-gray-400 w-full sm:w-auto">Probability:</span>
                         <div class="flex items-center gap-1"><div class="w-4 h-4 rounded prob-high"></div><span class="text-xs text-gray-500">High</span></div>
                         <div class="flex items-center gap-1"><div class="w-4 h-4 rounded prob-medium"></div><span class="text-xs text-gray-500">Medium</span></div>
                         <div class="flex items-center gap-1"><div class="w-4 h-4 rounded prob-low"></div><span class="text-xs text-gray-500">Low</span></div>
                         <div class="flex items-center gap-1"><div class="w-4 h-4 rounded prob-very-low border"></div><span class="text-xs text-gray-500">None</span></div>
                     </div>
                     

                     <!-- Month Navigation -->
                      <div class="month-nav flex items-center justify-between mb-4 px-4 py-2 bg-gray-50 rounded-xl border border-gray-100">
                          <button onclick="changeCalendarMonth(-1)" class="btn btn-ghost btn-sm btn-circle hover:bg-white hover:shadow-sm">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                          </button>
                          
                          <div class="relative flex items-center justify-center flex-1 mx-4">
                              <div class="month-title text-base font-bold text-gray-800 flex items-center gap-2 pointer-events-none">
                                  <span id="calendar-month-title">January 2026</span>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                              </div>
                              <!-- Invisible Overlay Input -->
                              <input type="month" id="calendar-jump-picker" 
                                     class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" 
                                     onchange="jumpToDate(this.value)">
                          </div>

                          <button onclick="changeCalendarMonth(1)" class="btn btn-ghost btn-sm btn-circle hover:bg-white hover:shadow-sm">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                          </button>
                      </div>
                     
                     <!-- Calendar Grid -->
                     <div class="calendar-grid" id="calendar-grid">
                         <!-- Days of week headers -->
                         <div class="calendar-header">Sun</div>
                         <div class="calendar-header">Mon</div>
                         <div class="calendar-header">Tue</div>
                         <div class="calendar-header">Wed</div>
                         <div class="calendar-header">Thu</div>
                         <div class="calendar-header">Fri</div>
                         <div class="calendar-header">Sat</div>
                         <!-- Day cells will be dynamically generated -->
                     </div>
                     
                     <!-- Current Dasha Display -->
                     <div class="mt-6 p-4 bg-gray-50 rounded-xl border border-gray-100 overflow-x-auto" id="current-dasha-display">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Current Running Dasha</div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2" id="current-dasha-lords">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Static KP Guide Section -->
                    <div class="mt-8 pt-8 border-t border-base-200">
                        <div class="collapse collapse-arrow bg-base-100 border border-base-200 rounded-lg shadow-sm">
                            <input type="checkbox" /> 
                            <div class="collapse-title text-xl font-medium flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-primary">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                                </svg>
                                KP Event Rule Book (Reference)
                            </div>
                            <div class="collapse-content"> 
                                <p class="mb-4 opacity-70 text-sm">KP Astrology assigns specific house combinations for different life events. This calendar calculates probabilities based on how many of these houses are activated by your current Dasha planets.</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üíç</span> Marriage / Relationship
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">2</span> <span class="badge badge-sm badge-neutral">7</span> <span class="badge badge-sm badge-neutral">11</span></div>
                                        <div class="text-xs opacity-60 mt-1">2=Family, 7=Spouse, 11=Desires</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üíº</span> Career / Job
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">2</span> <span class="badge badge-sm badge-neutral">6</span> <span class="badge badge-sm badge-neutral">10</span></div>
                                        <div class="text-xs opacity-60 mt-1">10=Profession, 6=Service, 2=Wealth</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üí∞</span> Finance / Money
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">2</span> <span class="badge badge-sm badge-neutral">6</span> <span class="badge badge-sm badge-neutral">11</span></div>
                                        <div class="text-xs opacity-60 mt-1">2=Accumulation, 11=Gains</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üè†</span> Property / Vehicle
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">4</span> <span class="badge badge-sm badge-neutral">11</span> <span class="badge badge-sm badge-neutral">12</span></div>
                                        <div class="text-xs opacity-60 mt-1">4=Assets, 11=Gain of Property</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üë∂</span> Childbirth
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">2</span> <span class="badge badge-sm badge-neutral">5</span> <span class="badge badge-sm badge-neutral">11</span></div>
                                        <div class="text-xs opacity-60 mt-1">5=Progeny, 2=Family extension</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>‚úàÔ∏è</span> Foreign Travel
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">3</span> <span class="badge badge-sm badge-neutral">9</span> <span class="badge badge-sm badge-neutral">12</span></div>
                                        <div class="text-xs opacity-60 mt-1">9=Long travel, 12=Foreign land</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üìö</span> Education
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">4</span> <span class="badge badge-sm badge-neutral">9</span> <span class="badge badge-sm badge-neutral">11</span></div>
                                        <div class="text-xs opacity-60 mt-1">4=Basic, 9=Higher Education</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üè•</span> Health Issues
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">1</span> <span class="badge badge-sm badge-neutral">6</span> <span class="badge badge-sm badge-neutral">8</span></div>
                                        <div class="text-xs opacity-60 mt-1">6=Disease, 8=Chronic/Surgery</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>‚öñÔ∏è</span> Legal / Litigation
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">6</span> <span class="badge badge-sm badge-neutral">7</span> <span class="badge badge-sm badge-neutral">12</span></div>
                                        <div class="text-xs opacity-60 mt-1">6=Arguments, 12=Punishment</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üöó</span> Short Travel
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">3</span> <span class="badge badge-sm badge-neutral">9</span></div>
                                        <div class="text-xs opacity-60 mt-1">3=Short journeys, 9=Travel</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>‚ö†Ô∏è</span> Obstacles / Losses
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">6</span> <span class="badge badge-sm badge-neutral">8</span> <span class="badge badge-sm badge-neutral">12</span></div>
                                        <div class="text-xs opacity-60 mt-1">Dusthana houses (malefic triad)</div>
                                    </div>
                                    <div class="p-3 bg-base-200 rounded-lg">
                                        <div class="flex items-center gap-2 font-bold mb-1">
                                            <span>üïâÔ∏è</span> Spiritual Progress
                                        </div>
                                        <div class="text-xs">Houses: <span class="badge badge-sm badge-neutral">5</span> <span class="badge badge-sm badge-neutral">9</span> <span class="badge badge-sm badge-neutral">12</span></div>
                                        <div class="text-xs opacity-60 mt-1">5=Merit, 9=Dharma, 12=Moksha</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     
                     </div> <!-- End calendar-view-content -->
                     
                 </div>
             </div>
         </section>
    </main>

    <!-- DAY DETAIL MODAL -->
    <div id="day-modal-backdrop" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" onclick="closeDayModal()">
        <div class="modal-box w-full max-w-lg bg-base-100 rounded-xl shadow-2xl relative" onclick="event.stopPropagation()">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeDayModal()">‚úï</button>
            
            <h3 id="modal-date-title" class="font-bold text-xl mb-4 text-center">Date Here</h3>
            
            <!-- Dasha Chain -->
            <div class="bg-base-200 p-3 rounded-lg mb-6 overflow-x-auto">
                <div class="text-center text-xs opacity-50 mb-2 uppercase tracking-wide font-bold">Active Dasha Chain</div>
                <div id="modal-dasha-chain" class="grid grid-cols-4 gap-2 text-center min-w-max">
                    <!-- JS Injected -->
                </div>
            </div>
            
            <div class="divider text-xs opacity-50">PREDICTED EVENTS</div>
            
            <!-- Events List -->
            <div id="modal-events-list" class="max-h-[50vh] overflow-y-auto custom-scroll pr-1">
                <!-- JS Injected -->
            </div>
            
            <div class="modal-action justify-center mt-6">
                <button class="btn btn-primary w-full" onclick="closeDayModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- BHAVA (HOUSE) MODAL -->
    <div id="bhava-modal-backdrop" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" onclick="closeBhavaModal()">
        <div class="modal-box w-full max-w-md bg-base-100 rounded-xl shadow-2xl relative" onclick="event.stopPropagation()">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeBhavaModal()">‚úï</button>
            
            <div class="text-center mb-6">
                <h3 id="bhava-modal-title" class="font-bold text-xl text-gray-800">House Details</h3>
                <p id="bhava-modal-subtitle" class="text-sm opacity-60">Significations</p>
            </div>
            
            <div id="bhava-modal-content">
                <!-- JS Injected -->
            </div>
            
            <div class="modal-action justify-center mt-6">
                <button class="btn btn-primary w-full" onclick="closeBhavaModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import astroEngine from './VedicAstroEngine.js';
        import jyotishTools from './JyotishTools.js';
        import kpEventEngine, { EVENT_TYPES } from './KPEventEngine.js';

        let tsControl;
        
        // Global State
        let calendarData = [];           // Generated calendar array
        let calendarNatalData = null;    // Natal chart data for calendar
        let calendarMoonLong = 0;
        let calendarBirthDate = null;
        let currentCalendarMonth = new Date(); // Initialize directly
        let activeEventTypes = new Set(['marriage', 'career', 'finance', 'education']); // Default selections

        window.onload = async () => {
            try {
                const loader = document.getElementById('loader');

                // Initialize Engine
                await astroEngine.init();
                
                // Initialize TomSelect (Empty first)
                tsControl = new TomSelect("#citySelect", {
                    valueField: 'id',
                    labelField: 'n',
                    searchField: ['n', 'st'], // Search both name and state
                    maxOptions: 50,
                    create: false,
                    placeholder: "Search City (e.g. Mumbai, New York)",
                    render: {
                        option: function(data, escape) {
                            return '<div class="flex justify-between items-center py-1"><span>' + escape(data.n) + '</span> <span class="text-xs text-gray-400 uppercase tracking-widest ml-2">' + escape(data.st) + '</span></div>';
                        },
                        item: function(data, escape) {
                            return '<div>' + escape(data.n) + ', ' + escape(data.st) + '</div>';
                        }
                    },
                    onChange: (value) => {
                        if(value && tsControl.options[value]) {
                            const data = tsControl.options[value];
                            document.getElementById('selectedLat').value = data.lat;
                            document.getElementById('selectedLng').value = data.lng;
                            document.getElementById('timezone').value = data.tz;
                            console.log("Selected:", data);
                        }
                    }
                });
                tsControl.disable(); // Disable until data loads

                // Load City Data
                // Fetch GZIPPED file to save bandwidth
                // Format: [Name, Lat, Lng, Tz, State]
                const res = await fetch('./indian_locations_state.json.gz');
                const buffer = await res.arrayBuffer();
                
                // Decompress
                const text = pako.ungzip(buffer, { to: 'string' });
                const rawData = JSON.parse(text);
                
                // Optimize mapping 
                // Filter garbage (starts with digit or too short)
                const options = rawData
                    .filter(d => !/^\d/.test(d[0]) && d[0].length > 2)
                    .map((d, i) => ({
                        id: i,
                        n: d[0],
                        lat: d[1],
                        lng: d[2],
                        tz: d[3],
                        st: d[4] // State index
                    }));
                
                tsControl.addOptions(options);
                tsControl.enable();
                
                loader.classList.add('hidden');
                document.getElementById('calcBtn').disabled = false;

            } catch (e) {
                console.error(e);
                alert("Init Failed: " + e.message);
                document.getElementById('loader').classList.add('hidden'); // Ensure loader hides on error
            }
        };

        window.generateChart = () => {
             const dateStr = document.getElementById('dob').value;
             const timeStr = document.getElementById('tob').value;
             // Timezone is now a STRING (IANA)
             const tzString = document.getElementById('timezone').value;
             const lat = parseFloat(document.getElementById('selectedLat').value);
             const lng = parseFloat(document.getElementById('selectedLng').value);
             const ayaMode = parseInt(document.getElementById('ayaMode').value);
             const calcMode = parseInt(document.getElementById('calcMode').value);

             if(!dateStr || !timeStr || isNaN(lat)) { 
                 alert("Please enter all details including a valid city."); 
                 return; 
             }
             
             // Calculate Numeric Offset from IANA string
             const tzOffset = getOffsetFromIANA(tzString, dateStr, timeStr);
             console.log("Calculated Offset for", tzString, "is", tzOffset);

             try {
                const button = document.getElementById('calcBtn');
                button.classList.add('loading');
                
                setTimeout(() => {
                    // Main Calc
                    const d1Result = astroEngine.calculate(dateStr, timeStr, tzOffset, lat, lng, {
                        ayanamsaMode: ayaMode,
                        calcModeFlag: calcMode,
                        houseSystem: 'P' 
                    });
                    
                    const kpResult = astroEngine.calculate(dateStr, timeStr, tzOffset, lat, lng, {
                         ayanamsaMode: ayaMode,
                         calcModeFlag: calcMode,
                         houseSystem: 'P'
                    });

                    d1Result.planets.forEach(p => {
                        p.vargas = {
                             d1: jyotishTools.getVargaPosition(p.longitude, 1),
                             d9: jyotishTools.getVargaPosition(p.longitude, 9)
                        };
                    });

                    const moonObj = d1Result.planets.find(p => p.name === "Moon");
                    const dashas = jyotishTools.calculateVimshottari(moonObj.longitude, dateStr);

                    const kpData = {
                        planets: kpResult.planets.map(p => ({ ...p, kp: jyotishTools.getKPLords(p.longitude) })),
                        cusps: kpResult.houses.houses.map((deg, idx) => {
                            const hNum = idx; 
                            if (hNum === 0) return null; 
                            return { id: hNum, dms: astroEngine.decimalToDMS(deg), kp: jyotishTools.getKPLords(deg) };
                        }).filter(x => x!==null)
                    };

                    const shadbala = jyotishTools.calculateShadbala(d1Result.planets);
                    const jaimini = jyotishTools.calculateJaimini(d1Result.planets);
                    const doshas = jyotishTools.checkDoshas(d1Result.planets);
                    const avkahada = jyotishTools.getAvkahada(moonObj.longitude);
                    const ashtakvarga = jyotishTools.calculateAshtakvarga(d1Result.planets);

                    renderDashboard(d1Result, dashas, kpData, shadbala, jaimini, doshas, avkahada, ashtakvarga);
                    
                    // --- CALENDAR DATA STORAGE ---
                    calendarBirthDate = dateStr;
                    calendarMoonLong = moonObj.longitude;
                    calendarNatalData = {
                        planets: d1Result.planets,
                        kpCusps: kpData.cusps,
                        cuspLongitudes: kpResult.houses.houses.slice(1) // Extract raw longitudes (skip index 0)
                    };
                    
                    // Set default calendar date range (today + 90 days)
                    const today = new Date();
                    // Calendar date input initialization removed
                    // Calendar date input initialization removed
                    // const endDate = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
                    // document.getElementById('calendarEndDate').value = endDate.toISOString().split('T')[0];
                    
                    // Initialize event pills
                    initEventPills();
                    
                    // Auto-generate calendar with default 10-year range
                    setTimeout(() => {
                        generateEventCalendar();
                    }, 500);
                    
                    // Calculate and render current running dasha immediately
                    const currentDasha = kpEventEngine.calculateDeepDasha(
                        calendarMoonLong,
                        calendarBirthDate,
                        today
                    );
                    renderCurrentDasha(currentDasha);
                    
                    button.classList.remove('loading');
                    // Scroll to Output
                    document.getElementById('output').classList.remove('hidden');
                    document.getElementById('event-calendar-section').classList.remove('hidden');
                    setTimeout(() => {
                         document.getElementById('output').classList.remove('opacity-0');
                         document.getElementById('output').scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                    
                }, 50); // Small delay for UI update

             } catch(e) {
                 console.error(e);
                 alert("Calc Error: " + e.message);
                 document.getElementById('calcBtn').classList.remove('loading');
             }
        };
        
        function getOffsetFromIANA(timeZone, dateStr, timeStr) {
            try {
                // "Asia/Kolkata", "2000-01-01", "12:00"
                // Construct date string for Intl
                const dt = new Date(`${dateStr}T${timeStr}`);
                
                // Get timezone specific string
                // options: timeZoneName: 'longOffset' returns "GMT+05:30"
                const str = dt.toLocaleString('en-US', { timeZone: timeZone, timeZoneName: 'longOffset' });
                
                // Check if result has GMT or UTC
                const match = str.match(/GMT([+-]\d{2}):(\d{2})/);
                if (match) {
                    const hours = parseInt(match[1]);
                    const minutes = parseInt(match[2]);
                    const sign = hours < 0 ? -1 : 1;
                    // Note: match[1] includes sign. parseInt("-05") is -5.
                    // If hours is -5, we subtract minutes? No. -5:30 means -(5 + 30/60).
                    // Logic: Absolute hours + minutes/60, then apply sign.
                    // Actually, if string is GMT-05:30. hours = -5. minutes = 30.
                    // We want -5.5.
                    // Math.abs(hours) + minutes/60 -> 5.5. Then apply sign.
                    const offset = (Math.abs(hours) + (minutes / 60)) * (hours >= 0 ? 1 : -1);
                    return offset;
                }
                
                if (str.includes("GMT") && !str.includes("GMT+")) return 0; // GMT+00:00 sometimes shows as GMT

                console.warn("Could not parse offset from", str, "Defaulting to 5.5");
                return 5.5; // Fallback
            } catch (e) {
                console.error("Timezone Parse Error", e);
                return 5.5; 
            }
        }

        function renderDashboard(data, dashas, kpData, shadbala, jaimini, doshas, avkahada, ashtakvarga) {
            // Safe fix: Check if element exists before setting.
            const ayaEl = document.getElementById('val-ayanamsa');
            if(ayaEl) ayaEl.innerText = astroEngine.decimalToDMS(data.meta.ayanamsaValue);

            const asc = data.planets[0];
            const moon = data.planets.find(p => p.name === "Moon");
            
            setText('val-ascDesc', asc.sign);
            setText('val-ascDeg', asc.dms);
            setText('val-moonSign', moon.sign);
            setText('val-moonNak', moon.nakshatra);
            
            setText('pan-tithi', data.panchanga.tithi);
            setText('pan-vara', data.panchanga.vara);
            setText('pan-nak', data.panchanga.nakshatra);
            setText('pan-yoga', data.panchanga.yoga);
            setText('pan-karana', data.panchanga.karana);

            // Get ascendant sign ID for house calculations
            const ascSignId = asc.signId; // 0-indexed (0=Aries)
            
            // Store shadbala globally for chart stats usage via renderSouthChart
            window.currentShadbalaData = shadbala;
            window.currentLagnaSignId = ascSignId; // Store Lagna for aspect calculation
            
            renderSouthChart('chart-d1', data.planets, 'd1', ascSignId);
            // For D9, lagna is based on navamsa ascendant
            const d9AscSignId = asc.vargas.d9.signId;
            renderSouthChart('chart-d9', data.planets, 'd9', d9AscSignId);

            const tbody = document.getElementById('planet-detail-body');
            tbody.innerHTML = '';
            data.planets.forEach(p => {
                const signLord = jyotishTools.getSignLord(p.sign);
                const starLord = jyotishTools.getNakshatraLord(p.nakshatraId);
                const pada = Math.floor((p.longitude % 13.3333333) / 3.3333333) + 1;
                const status = (p.isRetrograde) 
                    ? '<span class="badge badge-warning badge-xs">Ret</span>' 
                    : '<span class="badge badge-ghost badge-xs text-gray-400">Dir</span>';
                
                tbody.innerHTML += `<tr class="hover:bg-gray-50 transition-colors">
                    <td class="font-bold text-gray-700 flex items-center justify-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-[10px] planet-${p.name}">${p.name.substring(0,2)}</span>
                        ${p.name}
                    </td>
                    <td>${p.sign}</td>
                    <td class="font-mono text-xs text-gray-500">${p.dms}</td>
                    <td>${p.nakshatra}</td>
                    <td>${pada}</td>
                    <td>${signLord}</td>
                    <td class="font-bold text-primary">${starLord}</td>
                    <td>${status}</td>
                </tr>`;
            });

            // KP
            const cuspsBody = document.getElementById('kp-cusp-body');
            cuspsBody.innerHTML = '';
            kpData.cusps.forEach(c => {
                const k = c.kp;
                cuspsBody.innerHTML += `<tr class="hover:bg-gray-50">
                    <td class="font-bold text-gray-400">H${c.id}</td>
                    <td>${k.sign}</td>
                    <td class="font-mono text-xs">${c.dms}</td>
                    <td>${k.signLord}</td>
                    <td>${k.starLord}</td>
                    <td class="font-bold text-primary">${k.subLord}</td>
                </tr>`;
            });

            const kpPlBody = document.getElementById('kp-planet-body');
            kpPlBody.innerHTML = '';
            kpData.planets.forEach(p => {
                const k = p.kp;
                kpPlBody.innerHTML += `<tr class="hover:bg-gray-50">
                    <td class="font-bold flex gap-1 justify-center"><span class="planet-${p.name}">${p.name.substring(0,2)}</span></td>
                    <td class="font-mono text-xs">${p.dms}</td>
                    <td>${k.signLord}</td>
                    <td>${k.starLord}</td>
                    <td class="font-bold text-primary">${k.subLord}</td>
                </tr>`;
            });

            // SHADBALA
            const shadBody = document.getElementById('shadbala-body');
            shadBody.innerHTML = '';
            Object.keys(shadbala).forEach(key => {
                const s = shadbala[key];
                // Relative strength rough calc: > 1.0 (some standard ratios exist but simplified here)
                // Just showing total for now
                shadBody.innerHTML += `<tr>
                    <td class="font-bold text-left pl-4">${key}</td>
                    <td class="font-bold text-primary">${s.total}</td>
                    <td class="text-xs text-gray-400">RP</td>
                </tr>`;
            });

            // DASHAS - Store globally for deep dive
            window.calculatedDashas = dashas;
            const dashaBody = document.getElementById('dasha-body');
            dashaBody.innerHTML = '';
            dashas.forEach((d, idx) => {
                // Check if current date is within this Mahadasha
                const now = new Date();
                const isCurrent = now >= d.start && now <= d.end;
                const currentClass = isCurrent ? 'bg-primary/10' : '';
                
                dashaBody.innerHTML += `<tr class="dasha-row cursor-pointer hover:bg-gray-100 ${currentClass}" data-dasha-idx="${idx}" onclick="toggleDashaExpand(${idx})">
                    <td class="font-bold flex items-center gap-1">
                        <svg class="h-3 w-3 transition-transform dasha-arrow" id="dasha-arrow-${idx}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        ${d.lord}
                    </td>
                    <td class="font-mono text-xs">${d.start.toLocaleDateString()}</td>
                    <td class="font-mono text-xs">${d.end.toLocaleDateString()}</td>
                    <td class="text-gray-400">${d.duration.toFixed(1)}y</td>
                </tr>
                <tr class="dasha-expand hidden" id="dasha-expand-${idx}">
                    <td colspan="4" class="p-0">
                        <div class="pl-6 py-2 bg-gray-50 border-l-2 border-primary" id="antardasha-container-${idx}"></div>
                    </td>
                </tr>`;
            });

            // SPECIALTY
            document.getElementById('avkahada-body').innerHTML = `
                <tr class="border-b border-gray-50"><td>Gana</td><td class="font-bold text-gray-700 text-right">${avkahada.gana}</td></tr>
                <tr class="border-b border-gray-50"><td>Yoni</td><td class="font-bold text-gray-700 text-right">${avkahada.yoni}</td></tr>
                <tr><td>Nadi</td><td class="font-bold text-gray-700 text-right">${avkahada.nadi}</td></tr>
            `;

            const jmBody = document.getElementById('jaimini-body');
            jmBody.innerHTML = '';
            jaimini.forEach(k => {
                jmBody.innerHTML += `<tr>
                    <td class="font-bold text-primary">${k.karaka}</td>
                    <td>${k.planet}</td>
                    <td class="font-mono text-xs">${k.degree}¬∞</td>
                </tr>`;
            });

            const doshaContainer = document.getElementById('dosha-container');
            doshaContainer.innerHTML = '';
            if(doshas.manglik.isPresent) {
                doshaContainer.innerHTML += `<div class="badge badge-error badge-outline gap-2 p-3 font-medium">Manglik: ${doshas.manglik.reason}</div>`;
            } else {
                doshaContainer.innerHTML += `<div class="badge badge-success badge-outline gap-2 p-3 font-medium">No Manglik Dosha</div>`;
            }
            if(doshas.kalsarpa.isPresent) {
                doshaContainer.innerHTML += `<div class="badge badge-warning badge-outline gap-2 p-3 font-medium">Kalsarpa: ${doshas.kalsarpa.type}</div>`;
            }

            renderDataExport(data, dashas, kpData, shadbala, jaimini, doshas, avkahada, ashtakvarga);
        }
        
        function setText(id, val) {
            const el = document.getElementById(id);
            if(el) el.innerText = val;
        }

        // Rashi data: [English Name, Sanskrit Abbrev, Lord]
        const BHAVA_DATA = {
            1: { name: "Lagna Bhava (1st House)", theme: "Self, Personality, Physique", significations: ["Physical body", "Appearance", "Character", "Health", "Vitality", "Beginnings", "General well-being", "Head/Brain"] },
            2: { name: "Dhana Bhava (2nd House)", theme: "Wealth, Family, Speech", significations: ["Accumulated wealth", "Family", "Speech", "Food", "Right eye", "Early education", "Face", "Values"] },
            3: { name: "Sahaja Bhava (3rd House)", theme: "Siblings, Courage, Effort", significations: ["Younger siblings", "Courage", "Communication", "Writing", "Short travels", "Hands/Shoulders", "Hobbies", "Willpower"] },
            4: { name: "Matru Bhava (4th House)", theme: "Mother, Home, Happiness", significations: ["Mother", "Home/Property", "Vehicles", "Domestic happiness", "Primary education", "Heart/Chest", "Land", "Comforts"] },
            5: { name: "Putra Bhava (5th House)", theme: "Children, Intellect, Creativity", significations: ["Children", "Intelligence", "Romance", "Speculation", "Past life merit", "Creativity", "Stomach", "Mantra/Prayer"] },
            6: { name: "Ari Bhava (6th House)", theme: "Enemies, Disease, Debts", significations: ["Enemies/Rivals", "Diseases", "Debts", "Service/Work", "Litigation", "Accidents", "Intestines", "Maternal uncle"] },
            7: { name: "Kalatra Bhava (7th House)", theme: "Spouse, Partnership, Business", significations: ["Spouse/Marriage", "Business partners", "Legal contracts", "Public image", "Sexual desires", "Kidneys/Lower back", "Foreign travel"] },
            8: { name: "Randhra Bhava (8th House)", theme: "Longevity, Transformation", significations: ["Longevity", "Death/Rebirth", "Inheritance", "Occult/Mysticism", "Sudden events", "Reproductive organs", "Transformation"] },
            9: { name: "Dharma Bhava (9th House)", theme: "Luck, Father, Religion", significations: ["Fortune/Luck", "Father/Guru", "Religion/Spirituality", "Higher education", "Long travels", "Thighs", "Dharma/Duty"] },
            10: { name: "Karma Bhava (10th House)", theme: "Career, Status, Authority", significations: ["Profession/Career", "Reputation/Fame", "Authority/Power", "Father (South India)", "Knees", "Public Life", "Government"] },
            11: { name: "Labha Bhava (11th House)", theme: "Gains, Networks, Desires", significations: ["Gains/Income", "Elder siblings", "Friends/Network", "Fulfillment of desires", "Awards", "Calves/Ankles", "Hopes"] },
            12: { name: "Vyaya Bhava (12th House)", theme: "Losses, Moksha, Foreign", significations: ["Expenses/Losses", "Foreign lands", "Spirituality/Moksha", "Sleep/Dreams", "Hospitalization", "Feet", "Isolation"] }
        };

        const RASHI_DATA = [
            ["Aries", "Me·π£", "Mars"],
            ["Taurus", "V·πõ·π£", "Venus"],
            ["Gemini", "Mith", "Mercury"],
            ["Cancer", "Kark", "Moon"],
            ["Leo", "Si·πÉh", "Sun"],
            ["Virgo", "KanyƒÅ", "Mercury"],
            ["Libra", "TulƒÅ", "Venus"],
            ["Scorpio", "V·πõ≈õ", "Mars"],
            ["Sagittarius", "Dhan", "Jupiter"],
            ["Capricorn", "Mak", "Saturn"],
            ["Aquarius", "Kumb", "Saturn"],
            ["Pisces", "Mƒ´n", "Jupiter"]
        ];
        
        // Map lord name to CSS class
        function getLordClass(lordName) {
            const lordClasses = {
                "Sun": "rashi-sun",
                "Moon": "rashi-moon",
                "Mars": "rashi-mars",
                "Mercury": "rashi-mercury",
                "Jupiter": "rashi-jupiter",
                "Venus": "rashi-venus",
                "Saturn": "rashi-saturn"
            };
            return lordClasses[lordName] || "";
        }

        function renderSouthChart(containerId, planets, vargaKey, lagnaSignId = 0) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // Native Name for Center
            const nativeName = document.getElementById('name').value || "Native";
            
            // Stats Counters
            let kendraCount = 0;
            let trikonaCount = 0;
            let beneficCount = 0;
            let maleficCount = 0;
            
            // Natural Benefics: Jupiter, Venus, Mercury (usually), Moon (waxing)
            // Natural Malefics: Saturn, Mars, Sun, Rahu, Ketu
            const benefics = new Set(['Jupiter', 'Venus', 'Mercury', 'Moon']);
            const malefics = new Set(['Saturn', 'Mars', 'Sun', 'Rahu', 'Ketu']);
            
            for(let i=0; i<16; i++) {
                const div = document.createElement('div');
                div.id = `chart-cell-${i}`; // Add ID for aspect lines
                
                if (i===5 || i===6 || i===9 || i===10) {
                     if(i===5) {
                         div.className = "chart-center";
                         div.id = "chart-center-cell"; // ID for aspects
                         div.innerHTML = `
                            <div class="flex flex-col gap-1">
                                <span class="font-bold text-primary tracking-widest text-xs uppercase">${vargaKey === 'd1' ? 'Rashi Chart' : 'Navamsa'}</span>
                                <span class="text-[10px] font-semibold opacity-60">${nativeName}</span>
                            </div>
                         `;
                         container.appendChild(div);
                     }
                     continue; 
                 }
                 
                 // Get sign ID (1-12 based)
                 let signId = 0;
                 if(i===0) signId=12; else if(i===1) signId=1; else if(i===2) signId=2; else if(i===3) signId=3;
                 else if(i===4) signId=11; else if(i===7) signId=4;
                 else if(i===8) signId=10; else if(i===11) signId=5;
                 else if(i===12) signId=9; else if(i===13) signId=8; else if(i===14) signId=7; else if(i===15) signId=6;
                 
                 // Get rashi data (0-indexed)
                 const rashiInfo = RASHI_DATA[signId - 1];
                 const rashiName = rashiInfo[0];
                 const rashiAbbrev = rashiInfo[1];
                 const rashiLord = rashiInfo[2];
                 const lordClass = getLordClass(rashiLord);
                 
                 // Calculate house number (bhava) from lagna
                 const houseNum = ((signId - 1 - lagnaSignId + 12) % 12) + 1;
                 
                 // Identify planets in this house first
                 const housePlanets = planets.filter(p => {
                     const pSignId = p.vargas[vargaKey].signId + 1;
                     return pSignId === signId;
                 });
                 
                 // Update Stats if D1
                 if(vargaKey === 'd1') {
                     const pCount = housePlanets.length;
                     if([1, 4, 7, 10].includes(houseNum)) kendraCount += pCount;
                     if([1, 5, 9].includes(houseNum)) trikonaCount += pCount;
                     
                     housePlanets.forEach(p => {
                         if(benefics.has(p.name)) beneficCount++;
                         if(malefics.has(p.name)) maleficCount++;
                     });
                 }
                 
                 // Add class (remove conflicting border classes as CSS handles it)
                 div.className = `chart-cell ${lordClass}`;
                 div.dataset.houseNum = houseNum; // For aspects calculation
                 div.dataset.signId = signId;
                 
                 // Remove Click Handler for Bhava Modal from main div
                 div.onclick = null;
                 
                 // Add house number (top-left) and rashi with sign number (bottom-right)
                 // content-center is unused, using absolute positioning
                 
                 // Create Info Icon Button (Absolute Top Right)
                 // Using an SVG icon for cleanliness
                 const infoBtn = document.createElement('button');
                 infoBtn.className = "absolute top-0.5 right-0.5 btn btn-circle btn-ghost btn-xs w-4 h-4 min-h-0 p-0 z-10 opacity-40 hover:opacity-100 hover:bg-base-200 transition-opacity";
                 infoBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 text-primary"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>`;
                 infoBtn.onclick = (e) => {
                     e.stopPropagation();
                     window.openBhavaModal(houseNum, signId, rashiInfo, housePlanets, vargaKey);
                 };
                 
                 div.innerHTML = `
                     <span class="house-label">${houseNum}</span>
                     <span class="rashi-label text-gray-500">${rashiAbbrev} (${signId})</span>
                 `;
                 div.appendChild(infoBtn);
                 
                 housePlanets.forEach(p => {
                     const pSpan = document.createElement('span');
                     pSpan.className = `planet-glyph planet-${p.name}`;
                     pSpan.innerText = p.name.substring(0,2);
                     div.appendChild(pSpan);
                 });
                 container.appendChild(div);
            }
            
            // Update DOM for stats
            if(vargaKey === 'd1') {
                const kEl = document.getElementById('stats-kendra');
                const tEl = document.getElementById('stats-trikona');
                const sEl = document.getElementById('stats-strongest');

                
                // Calculate strongest planet if Shadbala data exists
                // We'll expose shadbalaData globally during generation
                if(window.currentShadbalaData) {
                    let strongest = { p: '-', v: 0 };
                    Object.entries(window.currentShadbalaData).forEach(([pName, data]) => {
                         const val = parseFloat(data.total);
                         if(val > strongest.v) strongest = { p: pName, v: val };
                    });
                    if(sEl) sEl.innerText = `${strongest.p} (${strongest.v.toFixed(0)})`;
                }
            }
        }

        /* -----------------------------------------------------
           DATA EXPORT & NARRATION LOGIC
           ----------------------------------------------------- */
        
        let exportData = { json: "", verbal: "" };

        function renderDataExport(data, dashas, kpData, shadbala, jaimini, doshas, avkahada, ashtakvarga) {
            
            // Construct full JSON object (clean clone or subset if circular refs exist - usually fine here)
            const fullObj = {
                basic: {
                    name: document.getElementById('name').value,
                    dob: document.getElementById('dob').value,
                    tob: document.getElementById('tob').value,
                    place: (tsControl && tsControl.getValue() !== "") ? tsControl.options[tsControl.getValue()].n : "Unknown",
                },
                meta: data.meta,
                panchanga: data.panchanga,
                planets: data.planets,
                kp: kpData,
                dashas: dashas,
                shadbala: shadbala,
                jaimini: jaimini,
                doshas: doshas,
                avkahada: avkahada,
                ashtakvarga: ashtakvarga
            };

            exportData.json = JSON.stringify(fullObj, null, 2);
            exportData.verbal = generateVerbalNarration(fullObj);

            // Render
            document.getElementById('json-view').innerText = exportData.json;
            // Simple formatter for verbal text
            document.getElementById('verbal-view').innerHTML = formatVerbalToHtml(exportData.verbal);

            document.getElementById('data-export-section').classList.remove('hidden');
        }

        function generateVerbalNarration(D) {
            let txt = "";
            const d = D.basic;
            const p = D.planets;

            // Header
            txt += `### Horoscope Details\n`;
            txt += `**Name:** ${d.name || "User"}  \n`;
            txt += `**Date of Birth:** ${d.dob}  \n`;
            txt += `**Time of Birth:** ${d.tob}  \n`;
            txt += `**Place:** ${d.place}  \n`;
            txt += `**Ayanamsa:** ${astroEngine.decimalToDMS(D.meta.ayanamsaValue)} (${document.getElementById('ayaMode').selectedOptions[0].text})\n\n`;

            // Panchanga
            txt += `### Panchanga\n`;
            txt += `- **Tithi:** ${D.panchanga.tithi}\n`;
            txt += `- **Vara (Day):** ${D.panchanga.vara}\n`;
            txt += `- **Nakshatra:** ${D.panchanga.nakshatra}\n`;
            txt += `- **Yoga:** ${D.panchanga.yoga}\n`;
            txt += `- **Karana:** ${D.panchanga.karana}\n\n`;

            // Planetary Details
            txt += `### Planetary Positions\n`;
            p.forEach(pl => {
                const signLord = jyotishTools.getSignLord(pl.sign);
                const pada = Math.floor((pl.longitude % 13.3333333) / 3.3333333) + 1;
                const status = (pl.isRetrograde) ? "Retrograde" : "Direct";
                
                txt += `- **${pl.name}:** Placed in **${pl.sign}** at **${pl.dms}**.\n`;
                txt += `  - Nakshatra: ${pl.nakshatra} (Pada ${pada})\n`;
                txt += `  - Sign Lord: ${signLord}\n`;
                txt += `  - Status: ${status}\n`;
            });
            txt += "\n";

            // Dasha
            txt += `### Vimshottari Dasha Rules\n`;
            D.dashas.forEach(dasha => {
                txt += `- **${dasha.lord} Dasha:** From ${new Date(dasha.start).toLocaleDateString()} to ${new Date(dasha.end).toLocaleDateString()} (${dasha.duration.toFixed(2)} Years)\n`;
            });
            txt += "\n";

            // Shadbala
            txt += `### Shadbala Strength\n`;
            Object.keys(D.shadbala).forEach(k => {
                txt += `- **${k}:** ${D.shadbala[k].total} Rupas\n`;
            });
            txt += "\n";

            // KP System
            txt += `### KP System Analysis\n`;
            txt += `**House Cusps (Bhavas):**\n`;
            D.kp.cusps.forEach(c => {
                 const k = c.kp;
                 txt += `- **House ${c.id}:** ${c.dms} in ${k.sign}. [SignL: ${k.signLord} | StarL: ${k.starLord} | SubL: ${k.subLord}]\n`;
            });
            txt += `\n**Planetary Significations:**\n`;
            D.kp.planets.forEach(pl => {
                const k = pl.kp;
                 txt += `- **${pl.name}:** [SignL: ${k.signLord} | StarL: ${k.starLord} | SubL: ${k.subLord}]\n`;
            });
            txt += "\n";

            // Analysis
            txt += `### Detailed Analysis\n`;
            txt += `**Avkahada Chakra:**\n`;
            txt += `- Gana: ${D.avkahada.gana}\n`;
            txt += `- Yoni: ${D.avkahada.yoni}\n`;
            txt += `- Nadi: ${D.avkahada.nadi}\n\n`;

            txt += `**Jaimini Karakas:**\n`;
            D.jaimini.forEach(j => {
                txt += `- ${j.karaka}: ${j.planet} (${j.degree}¬∞)\n`;
            });
            txt += "\n";

            txt += `**Dosha Analysis:**\n`;
            txt += `- **Manglik:** ${D.doshas.manglik.isPresent ? "Present (" + D.doshas.manglik.reason + ")" : "Absent"}\n`;
            txt += `- **Kalsarpa:** ${D.doshas.kalsarpa.isPresent ? "Present (" + D.doshas.kalsarpa.type + ")" : "Absent"}\n`;

            return txt;
        }

        function formatVerbalToHtml(text) {
            // Convert markdown style to HTML
            // IMPORTANT: Process headers and lists BEFORE replacing newlines
            return text
                .replace(/^### (.*?)$/gm, '<h3 class="text-lg font-bold text-primary mt-6 mb-2 border-b border-gray-100 pb-1">$1</h3>')
                .replace(/^- (.*?)$/gm, '<div class="ml-4 mb-1">‚Ä¢ $1</div>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
                .replace(/\n/g, '<br>');
        }

        window.toggleDataView = () => {
            const isVerbal = document.getElementById('viewToggle').checked;
            const jsonEl = document.getElementById('json-view');
            const verbalEl = document.getElementById('verbal-view');

            if(isVerbal) {
                jsonEl.classList.add('hidden');
                verbalEl.classList.remove('hidden');
            } else {
                verbalEl.classList.add('hidden');
                jsonEl.classList.remove('hidden');
            }
        }

        window.copyDataToClipboard = () => {
            const isVerbal = document.getElementById('viewToggle').checked;
            const content = isVerbal ? exportData.verbal : exportData.json;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.querySelector('#data-export-section button');
                const orig = btn.innerHTML;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Copied!`;
                setTimeout(() => { btn.innerHTML = orig }, 2000);
            });
        }

        window.switchChartTab = (chartKey, tabElement) => {
             // 1. Hide all chart views
             document.querySelectorAll('.chart-view').forEach(el => el.classList.add('hidden'));
             
             // 2. Show selected
             document.getElementById(`chart-container-${chartKey}`).classList.remove('hidden');
             
             // 3. Update Tab Styles
             const parent = tabElement.parentElement;
             parent.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
             tabElement.classList.add('tab-active');
        };

        /* -----------------------------------------------------
           MOBILE TAB NAVIGATION
           ----------------------------------------------------- */
        
        window.switchMobileTab = (tabKey, tabElement) => {
            // Remove active from all mobile content containers
            document.querySelectorAll('.mobile-tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Add active to selected tab content
            const targetContent = document.getElementById(`mobile-content-${tabKey}`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // Update tab styles
            document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('tab-active'));
            tabElement.classList.add('tab-active');
        };

        /* -----------------------------------------------------
           DASHA DEEP DIVE (Antardasha Expansion)
           ----------------------------------------------------- */
        
        const VIM_ORDER = ["Ketu", "Venus", "Sun", "Moon", "Mars", "Rahu", "Jupiter", "Saturn", "Mercury"];
        const DASHA_YEARS = { "Ketu": 7, "Venus": 20, "Sun": 6, "Moon": 10, "Mars": 7, "Rahu": 18, "Jupiter": 16, "Saturn": 19, "Mercury": 17 };
        
        function calculateAntardasha(mahadasha) {
            const results = [];
            const totalDays = (mahadasha.end - mahadasha.start) / (1000 * 60 * 60 * 24);
            const startIdx = VIM_ORDER.indexOf(mahadasha.lord);
            let currentDate = new Date(mahadasha.start);
            
            for (let i = 0; i < 9; i++) {
                const idx = (startIdx + i) % 9;
                const lord = VIM_ORDER[idx];
                const proportion = DASHA_YEARS[lord] / 120; // 120 = total Vimshottari years
                const days = totalDays * proportion;
                
                const endDate = new Date(currentDate);
                endDate.setTime(endDate.getTime() + (days * 24 * 60 * 60 * 1000));
                
                results.push({
                    lord: lord,
                    start: new Date(currentDate),
                    end: new Date(endDate),
                    durationMonths: (days / 30.4375).toFixed(1)
                });
                
                currentDate = new Date(endDate);
            }
            return results;
        }
        
        window.toggleDashaExpand = (idx) => {
            const expandRow = document.getElementById(`dasha-expand-${idx}`);
            const arrow = document.getElementById(`dasha-arrow-${idx}`);
            const container = document.getElementById(`antardasha-container-${idx}`);
            
            if (expandRow.classList.contains('hidden')) {
                // Expand - Calculate Antardasha
                expandRow.classList.remove('hidden');
                arrow.style.transform = 'rotate(90deg)';
                
                // Calculate Antardasha for this Mahadasha
                const mahadasha = window.calculatedDashas[idx];
                const antardashas = calculateAntardasha(mahadasha);
                
                let html = '<table class="table table-xs w-full">';
                html += '<thead><tr class="text-gray-400 text-[10px]"><th>Bhukti</th><th>Start</th><th>End</th><th>Dur</th></tr></thead>';
                html += '<tbody>';
                
                const now = new Date();
                antardashas.forEach(ad => {
                    const isCurrent = now >= ad.start && now <= ad.end;
                    const rowClass = isCurrent ? 'bg-primary/20 font-semibold' : '';
                    html += `<tr class="${rowClass}">
                        <td class="font-medium">${mahadasha.lord}-${ad.lord}</td>
                        <td class="font-mono text-[10px]">${ad.start.toLocaleDateString()}</td>
                        <td class="font-mono text-[10px]">${ad.end.toLocaleDateString()}</td>
                        <td class="text-gray-400">${ad.durationMonths}m</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } else {
                // Collapse
                expandRow.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        /* -----------------------------------------------------
           PROFILE MANAGEMENT (localStorage)
           ----------------------------------------------------- */
        
        const PROFILES_KEY = 'suta_profiles';
        
        function getProfiles() {
            const data = localStorage.getItem(PROFILES_KEY);
            return data ? JSON.parse(data) : [];
        }
        
        function saveProfiles(profiles) {
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
        }
        
        function renderProfilesList() {
            const profiles = getProfiles();
            const list = document.getElementById('profilesList');
            
            if (profiles.length === 0) {
                list.innerHTML = '<li class="text-gray-400 text-xs px-2 py-2">No saved profiles</li>';
                return;
            }
            
            list.innerHTML = profiles.map((p, idx) => `
                <li class="grid grid-cols-[1fr_auto_auto] items-center gap-3 px-2 py-2 hover:bg-gray-50 rounded-lg">
                    <button onclick="loadProfile(${idx})" class="text-left text-sm font-medium text-gray-700 hover:text-primary truncate">
                        ${p.name || 'Unnamed'}
                    </button>
                    <span class="text-[10px] text-gray-400 whitespace-nowrap">${p.dob}</span>
                    <button onclick="deleteProfile(${idx})" class="btn btn-ghost btn-xs text-gray-400 hover:text-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </li>
            `).join('');
        }
        
        window.saveCurrentProfile = () => {
            const name = document.getElementById('name').value.trim();
            const dob = document.getElementById('dob').value;
            const tob = document.getElementById('tob').value;
            const cityValue = tsControl ? tsControl.getValue() : '';
            
            if (!name) {
                alert('Please enter a name to save the profile.');
                return;
            }
            if (!dob || !tob) {
                alert('Please fill in date and time of birth.');
                return;
            }
            
            // Get city data
            let cityData = null;
            if (cityValue && tsControl.options[cityValue]) {
                const c = tsControl.options[cityValue];
                cityData = { id: cityValue, n: c.n, lat: c.lat, lng: c.lng, tz: c.tz, st: c.st };
            }
            
            const profile = {
                name: name,
                dob: dob,
                tob: tob,
                city: cityData,
                ayaMode: document.getElementById('ayaMode').value,
                calcMode: document.getElementById('calcMode').value,
                savedAt: new Date().toISOString()
            };
            
            const profiles = getProfiles();
            
            // Check if profile with same name exists
            const existingIdx = profiles.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
            if (existingIdx >= 0) {
                if (confirm(`Profile "${name}" already exists. Do you want to update it?`)) {
                    profiles[existingIdx] = profile;
                } else {
                    return;
                }
            } else {
                profiles.push(profile);
            }
            
            saveProfiles(profiles);
            renderProfilesList();
            
            // Flash feedback
            const btn = document.querySelector('[onclick="saveCurrentProfile()"]');
            const origText = btn.innerHTML;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Saved!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-primary');
            setTimeout(() => {
                btn.innerHTML = origText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 1500);
        };
        
        window.loadProfile = (idx) => {
            const profiles = getProfiles();
            const p = profiles[idx];
            if (!p) return;
            
            // Set form values
            document.getElementById('name').value = p.name || '';
            document.getElementById('dob').value = p.dob || '';
            document.getElementById('tob').value = p.tob || '';
            document.getElementById('ayaMode').value = p.ayaMode || '27';
            document.getElementById('calcMode').value = p.calcMode || '16';
            
            // Set city if available
            if (p.city && tsControl) {
                // Add the option if not present
                if (!tsControl.options[p.city.id]) {
                    tsControl.addOption(p.city);
                }
                tsControl.setValue(p.city.id, true);
                
                // Set hidden fields
                document.getElementById('selectedLat').value = p.city.lat;
                document.getElementById('selectedLng').value = p.city.lng;
                document.getElementById('timezone').value = p.city.tz;
            }
            
            // Close dropdown
            document.activeElement.blur();
            
            // Visual feedback - scroll to input section
            document.getElementById('input-section').scrollIntoView({ behavior: 'smooth' });
        };
        
        window.deleteProfile = (idx) => {
            const profiles = getProfiles();
            const p = profiles[idx];
            if (!p) return;
            
            if (confirm(`Delete profile "${p.name}"?`)) {
                profiles.splice(idx, 1);
                saveProfiles(profiles);
                renderProfilesList();
            }
        };
        
        // Initialize profiles list on page load
        setTimeout(renderProfilesList, 100);

        /* -----------------------------------------------------
           DARK/LIGHT THEME TOGGLE
           ----------------------------------------------------- */
        
        const THEME_KEY = 'suta_theme';
        
        function getStoredTheme() {
            return localStorage.getItem(THEME_KEY) || 'light';
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem(THEME_KEY, theme);
            updateThemeIcons(theme);
        }
        
        function updateThemeIcons(theme) {
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            if (sunIcon && moonIcon) {
                if (theme === 'dark') {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }
            
            // Update chart colors if chart exists
            if (typeof updateChartTheme === 'function') {
                updateChartTheme();
            }
        }
        
        window.toggleTheme = () => {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = current === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        };
        
        
        /* =====================================================
           EVENT CALENDAR FUNCTIONS
           ===================================================== */
        
        // Initialize event pills
        function initEventPills() {
            const container = document.getElementById('event-pills-container');
            if (!container) return;
            
            container.innerHTML = EVENT_TYPES.map(evt => {
                const isActive = activeEventTypes.has(evt.id);
                return `<div class="event-pill ${isActive ? 'active' : ''}" data-event-id="${evt.id}" onclick="toggleEventPill('${evt.id}')">
                    <span class="pill-icon">${evt.icon}</span>
                    <span>${evt.name}</span>
                </div>`;
            }).join('');
        }
        
        window.toggleEventPill = (eventId) => {
            if (activeEventTypes.has(eventId)) {
                activeEventTypes.delete(eventId);
            } else {
                activeEventTypes.add(eventId);
            }
            // Update visual
            const pill = document.querySelector(`[data-event-id="${eventId}"]`);
            if (pill) pill.classList.toggle('active');
            // Re-render calendar AND chart if data exists
            if (calendarData.length > 0) {
                renderCalendarMonth();
                // Also update heatmap chart
                renderHeatmapChart(currentChartTimeframe);
            }
        };

        window.jumpToDate = (val) => {
            if(!val) return;
            const targetDate = new Date(val + '-01'); // YYYY-MM
            if(isNaN(targetDate.getTime())) return;
            
            // Check bounds
            // Assuming we have generated +/- 5 years. 
            // If out of bounds, maybe we should regenerate? For now, just clamp or nav.
            
            currentCalendarMonth = targetDate;
            renderCalendarMonth();
        };
        
        window.generateEventCalendar = () => {
            if (!calendarNatalData || !calendarBirthDate) {
                alert('Please generate your horoscope first.');
                return;
            }
            
            // Auto-calculate range: 5 years back to 5 years forward (Total 10 years)
            const today = new Date();
            const startDate = new Date(today);
            startDate.setFullYear(today.getFullYear() - 5);
            
            const endDate = new Date(today);
            endDate.setFullYear(today.getFullYear() + 5);
            
            const days = Math.ceil((endDate - startDate) / (24 * 60 * 60 * 1000)) + 1;
            
            // Build house significators from natal data
            kpEventEngine.buildHouseSignificators(calendarNatalData.planets, calendarNatalData.cuspLongitudes);
            
            // Expose to window for modal to access
            window.currentHouseSignificators = kpEventEngine.houseSignificators;
            
            // Generate calendar
            calendarData = kpEventEngine.generateCalendar(
                calendarMoonLong,
                calendarBirthDate,
                calendarNatalData.planets,
                calendarNatalData.cuspLongitudes,
                startDate,
                Math.min(days, 4000), // Cap at ~11 years for safety
                null // All event types for data, filter in render
            );
            
            // Default to TODAY, not 5 years ago
            currentCalendarMonth = new Date(today);
            // Ensure we are at the first of the month
            currentCalendarMonth.setDate(1);
            renderCalendarMonth();
            
            // Show current day's dasha
            const todayData = calendarData.find(d => d.date === new Date().toISOString().split('T')[0]);
            if (todayData) {
                renderCurrentDasha(todayData.dasha);
            }
            
            // Initialize heatmap chart
            setTimeout(() => {
                renderHeatmapChart(currentChartTimeframe);
            }, 100);
        };
        
        // ===== HEATMAP CHART SYSTEM =====
        
        let currentChartTimeframe = '3M';
        
        // Event type color mapping
        window.EVENT_COLORS = {
            'marriage': '#ec4899',
            'career': '#8b5cf6',
            'finance': '#22c55e',
            'education': '#f59e0b',
            'property': '#06b6d4',
            'children': '#f97316',
            'health': '#dc2626',
            'travel': '#14b8a6',
            'legal': '#64748b',
            'spiritual': '#a855f7'
        };
        
        // Get probability color class (0-7 scale)
        function getProbabilityClass(score) {
            if (score <= 0) return 'prob-0';
            if (score <= 15) return 'prob-1';
            if (score <= 30) return 'prob-2';
            if (score <= 45) return 'prob-3';
            if (score <= 60) return 'prob-4';
            if (score <= 75) return 'prob-5';
            if (score <= 90) return 'prob-6';
            return 'prob-7';
        }
        
        // Aggregate data for large timeframes
        function aggregateDataByInterval(data, intervalDays) {
            if (intervalDays <= 1) return data;
            
            const aggregated = [];
            for (let i = 0; i < data.length; i += intervalDays) {
                const chunk = data.slice(i, i + intervalDays);
                if (chunk.length === 0) continue;
                
                const avgDate = chunk[Math.floor(chunk.length / 2)].date;
                const eventsMap = new Map();
                
                chunk.forEach(day => {
                    day.events.forEach(e => {
                        if (!eventsMap.has(e.type)) {
                            eventsMap.set(e.type, { ...e, score: 0, count: 0 });
                        }
                        const existing = eventsMap.get(e.type);
                        existing.score += e.score;
                        existing.count++;
                    });
                });
                
                const averagedEvents = Array.from(eventsMap.values()).map(e => ({
                    ...e,
                    score: Math.round(e.score / e.count)
                }));
                
                aggregated.push({
                    date: avgDate,
                    events: averagedEvents,
                    isAggregated: true,
                    dateRange: `${chunk[0].date} to ${chunk[chunk.length-1].date}`
                });
            }
            return aggregated;
        }
        
        // Render summary cards at top
        function renderSummaryCards(processedData) {
            const container = document.getElementById('summary-cards');
            if (!container) return;
            
            const activeTypes = EVENT_TYPES.filter(et => activeEventTypes.has(et.id));
            
            container.innerHTML = activeTypes.map(eventType => {
                // Calculate stats
                const scores = processedData.map(d => {
                    const evt = d.events.find(e => e.type === eventType.id);
                    return evt ? evt.score : 0;
                });
                
                const avgScore = scores.length > 0 
                    ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) 
                    : 0;
                
                // Find peak
                let peakIdx = 0;
                let peakScore = 0;
                scores.forEach((s, i) => {
                    if (s > peakScore) { peakScore = s; peakIdx = i; }
                });
                
                const peakDate = processedData[peakIdx]?.date || '';
                const peakDisplay = peakDate 
                    ? new Date(peakDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    : '-';
                
                // Generate sparkline path
                const sparklinePath = generateSparklinePath(scores, 100, 28);
                
                const color = EVENT_COLORS[eventType.id] || '#64748b';
                
                return `
                    <div class="summary-card" data-event-id="${eventType.id}">
                        <div class="summary-card-header">
                            <span class="summary-card-icon">${eventType.icon}</span>
                            <span>${eventType.name.split('/')[0].trim()}</span>
                        </div>
                        <div class="summary-card-sparkline">
                            <svg viewBox="0 0 100 28" preserveAspectRatio="none">
                                <path d="${sparklinePath}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="summary-card-stats">
                            <span>Avg: ${avgScore}%</span>
                            <span class="summary-card-peak">Peak: ${peakDisplay}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Generate SVG path for sparkline
        function generateSparklinePath(scores, width, height) {
            if (scores.length === 0) return '';
            
            const maxScore = Math.max(...scores, 1);
            const step = width / Math.max(scores.length - 1, 1);
            
            return scores.map((score, i) => {
                const x = i * step;
                const y = height - (score / maxScore) * (height - 4) - 2;
                return `${i === 0 ? 'M' : 'L'} ${x.toFixed(1)} ${y.toFixed(1)}`;
            }).join(' ');
        }
        
        // Main heatmap render function
        function renderHeatmapChart(timeframe = currentChartTimeframe) {
            if (!calendarData || calendarData.length === 0) return;
            currentChartTimeframe = timeframe;
            
            // Calculate date range
            const today = new Date();
            let startDate, endDate, aggregationInterval = 1;
            
            switch (timeframe) {
                case '1W': startDate = new Date(today); endDate = new Date(today); endDate.setDate(today.getDate() + 7); break;
                case '1M': startDate = new Date(today); endDate = new Date(today); endDate.setDate(today.getDate() + 30); break;
                case '3M': startDate = new Date(today); endDate = new Date(today); endDate.setDate(today.getDate() + 90); aggregationInterval = 2; break;
                case '6M': startDate = new Date(today); endDate = new Date(today); endDate.setDate(today.getDate() + 180); aggregationInterval = 3; break;
                case '1Y': startDate = new Date(today); endDate = new Date(today); endDate.setFullYear(today.getFullYear() + 1); aggregationInterval = 7; break;
                case 'ALL': default:
                    startDate = new Date(calendarData[0].date);
                    endDate = new Date(calendarData[calendarData.length - 1].date);
                    aggregationInterval = 14;
                    break;
            }
            
            // Filter and aggregate
            const filteredData = calendarData.filter(d => {
                const date = new Date(d.date);
                return date >= startDate && date <= endDate;
            });
            
            const processedData = aggregateDataByInterval(filteredData, aggregationInterval);
            
            // Render summary cards
            renderSummaryCards(processedData);
            
            // Get active event types
            const activeTypes = EVENT_TYPES.filter(et => activeEventTypes.has(et.id));
            
            // Render Y-axis labels
            const yAxis = document.getElementById('heatmap-y-labels');
            yAxis.innerHTML = activeTypes.map(et => `
                <div class="heatmap-y-label">
                    <span class="heatmap-y-label-icon">${et.icon}</span>
                    <span>${et.name.split('/')[0].trim().substring(0, 8)}</span>
                </div>
            `).join('');
            
            // Render X-axis labels (intelligent spacing)
            const xAxis = document.getElementById('heatmap-x-labels');
            const cellWidth = window.innerWidth < 640 ? 20 : 24;
            const labelInterval = Math.max(1, Math.floor(processedData.length / 15)); // ~15 labels max
            
            xAxis.innerHTML = processedData.map((day, i) => {
                const showLabel = i % labelInterval === 0;
                const dateObj = new Date(day.date);
                const label = showLabel 
                    ? dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    : '';
                return `<div class="heatmap-x-label" style="width:${cellWidth}px">${label}</div>`;
            }).join('');
            
            // Render grid
            const grid = document.getElementById('heatmap-grid');
            grid.innerHTML = activeTypes.map(eventType => {
                const rowCells = processedData.map(day => {
                    const evt = day.events.find(e => e.type === eventType.id);
                    const score = evt ? evt.score : 0;
                    const probClass = getProbabilityClass(score);
                    const dateStr = day.date;
                    
                    return `<div class="heatmap-cell ${probClass}" 
                                data-date="${dateStr}" 
                                data-event="${eventType.id}" 
                                data-score="${score}"
                                title="${eventType.name}: ${score}%"
                                style="width:${cellWidth}px;height:${cellWidth}px"
                                onclick="handleHeatmapClick('${dateStr}')"
                                onmouseenter="showHeatmapTooltip(event, '${dateStr}', '${eventType.id}', ${score})"
                                onmouseleave="hideHeatmapTooltip()"></div>`;
                }).join('');
                
                return `<div class="heatmap-row">${rowCells}</div>`;
            }).join('');
            
            // Update timeframe buttons
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === timeframe) btn.classList.add('active');
            });
        }
        
        // Tooltip handling
        window.showHeatmapTooltip = (event, dateStr, eventId, score) => {
            const tooltip = document.getElementById('heatmap-tooltip');
            const eventType = EVENT_TYPES.find(e => e.id === eventId);
            const dateDisplay = new Date(dateStr).toLocaleDateString('en-US', { 
                weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' 
            });
            
            tooltip.innerHTML = `
                <div class="font-bold mb-1">${dateDisplay}</div>
                <div class="flex items-center gap-2">
                    <span>${eventType?.icon || ''}</span>
                    <span>${eventType?.name || eventId}</span>
                    <span class="font-bold ml-auto" style="color: ${EVENT_COLORS[eventId] || '#64748b'}">${score}%</span>
                </div>
                <div class="text-[10px] opacity-60 mt-1">Click for details</div>
            `;
            
            // Position tooltip
            const x = event.pageX + 10;
            const y = event.pageY - 10;
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
            tooltip.classList.add('visible');
        };
        
        window.hideHeatmapTooltip = () => {
            const tooltip = document.getElementById('heatmap-tooltip');
            tooltip.classList.remove('visible');
        };
        
        // Handle cell click - navigate to calendar and open day modal
        window.handleHeatmapClick = (dateStr) => {
            const clickedDate = new Date(dateStr);
            
            // Update calendar month to show the clicked date's month
            currentCalendarMonth = new Date(clickedDate.getFullYear(), clickedDate.getMonth(), 1);
            
            // Switch to calendar view
            switchCalendarView('calendar');
            
            // Re-render calendar to the correct month
            renderCalendarMonth();
            
            // Highlight and open the day modal after a short delay (for DOM update)
            setTimeout(() => {
                const cell = document.querySelector(`[data-date="${dateStr}"]`);
                if (cell) {
                    cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    cell.click(); // Open day modal
                }
            }, 150);
        };
        
        // Timeframe setter
        window.setChartTimeframe = function(timeframe) {
            currentChartTimeframe = timeframe;
            renderHeatmapChart(timeframe);
        };
        
        // View switcher
        window.switchCalendarView = (view) => {
            const chartView = document.getElementById('chart-view');
            const calendarView = document.getElementById('calendar-view');
            const tabs = document.querySelectorAll('.chart-tab');
            
            if (view === 'chart') {
                chartView.classList.add('active');
                calendarView.classList.remove('active');
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
                
                setTimeout(() => {
                    if (calendarData && calendarData.length > 0) {
                        renderHeatmapChart(currentChartTimeframe);
                    }
                }, 100);
            } else {
                chartView.classList.remove('active');
                calendarView.classList.add('active');
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
            }
        };
        
        // Update chart on theme change
        function updateChartTheme() {
            if (calendarData && calendarData.length > 0) {
                renderHeatmapChart(currentChartTimeframe);
            }
        }
        

        
        function renderCalendarMonth() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            
            // Clear existing day cells (keep headers)
            const headers = Array.from(grid.querySelectorAll('.calendar-header'));
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h));
            
            // Get month boundaries
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay(); // 0 = Sun
            
            // Update title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const dayNamesShort = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            document.getElementById('calendar-month-title').textContent = `${monthNames[month]} ${year}`;
            
            // Sync date picker value
            const pickerVal = `${year}-${String(month + 1).padStart(2, '0')}`;
            const picker = document.getElementById('calendar-jump-picker');
            if(picker && picker.value !== pickerVal) {
                picker.value = pickerVal;
            }
            
            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-cell empty';
                grid.appendChild(emptyCell);
            }
            
            // Get today's date string for comparison
            const todayStr = new Date().toISOString().split('T')[0];
            
            // Day cells
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = calendarData.find(d => d.date === dateStr);
                const isToday = dateStr === todayStr;
                
                // Determine Day Name for mobile view
                const currentDayOfWeekIdx = (startDayOfWeek + (day - 1)) % 7;
                const dayName = dayNamesShort[currentDayOfWeekIdx];
                
                const cell = document.createElement('div');
                cell.className = 'calendar-cell' + (isToday ? ' today' : '');
                cell.dataset.date = dateStr;
                
                if (dayData) {
                    // Filter events by active types and get max score
                    const activeEvents = dayData.events.filter(e => activeEventTypes.has(e.type));
                    const maxScore = activeEvents.length > 0 ? Math.max(...activeEvents.map(e => e.score)) : 0;
                    const dominantEvent = activeEvents.length > 0 ? activeEvents.reduce((a, b) => a.score > b.score ? a : b) : null;
                    
                    // Apply probability class
                    if (maxScore >= 70) cell.classList.add('prob-high');
                    else if (maxScore >= 40) cell.classList.add('prob-medium');
                    else if (maxScore > 0) cell.classList.add('prob-low');
                    else cell.classList.add('prob-very-low');
                    
                    cell.innerHTML = `
                        <div class="day-num">
                            <span>${day}</span>
                            <span class="day-name-mobile">${dayName}</span>
                        </div>
                        ${dominantEvent && maxScore > 0 ? `
                            <div class="flex items-center gap-1">
                                <span class="text-lg">${dominantEvent.icon}</span>
                                <span class="score-badge">${maxScore}%</span>
                            </div>
                        ` : ''}
                    `;
                    
                    cell.onclick = () => openDayModal(dayData, dayName);
                } else {
                    cell.classList.add('prob-very-low');
                    cell.innerHTML = `
                        <div class="day-num">
                            <span>${day}</span>
                            <span class="day-name-mobile">${dayName}</span>
                        </div>`;
                }
                
                grid.appendChild(cell);
            }
        }
        
        window.changeCalendarMonth = (delta) => {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
            renderCalendarMonth();
        };
        
        function renderCurrentDasha(dasha) {
            const container = document.getElementById('current-dasha-lords');
            if (!container) return;
            
            container.innerHTML = `
                <div class="flex items-center gap-1">
                    <span class="text-xs text-gray-400">MD:</span>
                    <span class="badge badge-primary">${dasha.mahadasha}</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-xs text-gray-400">AD:</span>
                    <span class="badge badge-secondary">${dasha.antardasha}</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-xs text-gray-400">PD:</span>
                    <span class="badge badge-accent">${dasha.pratyantar}</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-xs text-gray-400">SD:</span>
                    <span class="badge badge-ghost">${dasha.sookshma}</span>
                </div>
            `;
        }
        
        function openDayModal(dayData, dayName) {
            const backdrop = document.getElementById('day-modal-backdrop');
            const dateTitle = document.getElementById('modal-date-title');
            const dashaChain = document.getElementById('modal-dasha-chain');
            const eventsList = document.getElementById('modal-events-list');
            
            // Set date title
            const dateObj = new Date(dayData.date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            dateTitle.textContent = formattedDate;
            
            // Dasha chain
            dashaChain.innerHTML = `
                <div class="stat place-items-center">
                    <div class="stat-title text-xs">Mahadasha</div>
                    <div class="stat-value text-lg text-primary">${dayData.dasha.mahadasha}</div>
                </div>
                <div class="stat place-items-center">
                    <div class="stat-title text-xs">Antardasha</div>
                    <div class="stat-value text-lg text-secondary">${dayData.dasha.antardasha}</div>
                </div>
                <div class="stat place-items-center">
                    <div class="stat-title text-xs">Pratyantar</div>
                    <div class="stat-value text-lg text-accent">${dayData.dasha.pratyantar}</div>
                </div>
                <div class="stat place-items-center">
                    <div class="stat-title text-xs">Sookshma</div>
                    <div class="stat-value text-lg">${dayData.dasha.sookshma}</div>
                </div>
            `;
            
            // Active events with reasoning
            const activeEvents = dayData.events
                .filter(e => activeEventTypes.has(e.type) && e.score > 0)
                .sort((a, b) => b.score - a.score);
                
            if (activeEvents.length > 0) {
                eventsList.innerHTML = activeEvents.map(e => `
                    <div class="p-4 bg-base-200 rounded-lg mb-4">
                        <div class="flex items-center justify-between mb-3 border-b border-base-300 pb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${e.icon}</span>
                                <span class="font-bold text-lg">${e.name}</span>
                            </div>
                            <div class="badge ${e.score >= 70 ? 'badge-success' : (e.score >= 40 ? 'badge-warning' : 'badge-ghost')} text-white font-bold p-3">
                                ${e.score}% ${e.score >= 70 ? 'High' : (e.score >= 40 ? 'Medium' : 'Low')}
                            </div>
                        </div>
                        
                        <div class="text-sm opacity-80 mb-2 font-semibold">Contributing Factors (Why?):</div>
                        <div class="space-y-2">
                            ${e.contributors && e.contributors.length > 0 ? e.contributors.map(c => {
                                // Get planet significations for display
                                const planetSig = (c.level !== 'bonus' && c.level !== 'transit' && window.currentHouseSignificators && window.currentHouseSignificators[c.lord]) 
                                    ? Array.from(window.currentHouseSignificators[c.lord]).sort((a,b) => a-b).join(', ')
                                    : '';
                                return `
                                <div class="contributor-item flex justify-between items-center">
                                    <div>
                                        <div class="contributor-level">${c.level === 'bonus' ? '‚ú® Synergy Bonus' : (c.level === 'transit' ? 'ü™ê Transit Trigger' : c.level)}</div>
                                        <div class="text-xs opacity-70">
                                            ${c.level === 'bonus' 
                                                ? 'All dasha lords signify event houses' 
                                                : `<strong>${c.lord}</strong>${planetSig ? ` <span class="badge badge-xs badge-outline">${planetSig}</span>` : ''} ‚Üí houses ${c.matched.join(', ')}`}
                                        </div>
                                    </div>
                                    <div class="font-mono font-bold text-success">+${c.points}%</div>
                                </div>
                            `}).join('') : '<div class="text-xs opacity-50 italic">No direct significators found.</div>'}
                        </div>
                    </div>
                `).join('');
            } else {
                eventsList.innerHTML = `
                    <div class="text-center py-8 opacity-50">
                        <div class="text-4xl mb-2">üò¥</div>
                        <div>No significant events predicted for this day based on selected filters.</div>
                    </div>
                `;
            }
            
            // Show modal
            backdrop.classList.remove('hidden');
        }
        
        window.closeDayModal = () => {
            document.getElementById('day-modal-backdrop').classList.add('hidden');
        };
        
        // --- BHAVA (HOUSE) MODAL ---
        window.openBhavaModal = (houseNum, signId, rashiInfo, housePlanets, vargaKey) => {
            const backdrop = document.getElementById('bhava-modal-backdrop');
            const title = document.getElementById('bhava-modal-title');
            const subtitle = document.getElementById('bhava-modal-subtitle');
            const content = document.getElementById('bhava-modal-content');
            
            const bhava = BHAVA_DATA[houseNum];
            const signName = rashiInfo[0];
            const signLord = rashiInfo[2];
            
            title.innerHTML = `<span class="text-primary">House ${houseNum}</span>: ${bhava.name.split('(')[0].trim()}`;
            subtitle.innerHTML = `Governs: ${bhava.theme}`;
            
            let html = `
                <div class="space-y-4">
                    <!-- Sign Information -->
                    <div class="p-3 bg-base-200 rounded-lg flex items-center justify-between">
                        <div>
                            <div class="text-xs uppercase font-bold opacity-60">Occupying Sign</div>
                            <div class="text-lg font-bold">${signName}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs uppercase font-bold opacity-60">Sign Lord</div>
                            <div class="text-lg font-bold ${getLordClass(signLord)} px-2 rounded">${signLord}</div>
                        </div>
                    </div>
                    
                    <!-- Planets in House -->
                    <div>
                        <div class="text-xs uppercase font-bold opacity-60 mb-2">Planets in this House</div>
                        ${housePlanets.length > 0 
                            ? `<div class="flex flex-wrap gap-2">
                                ${housePlanets.map(p => `
                                    <div class="badge badge-lg p-3 gap-2 planet-${p.name} bg-opacity-10 opacity-100">
                                        <span class="font-bold">${p.name}</span>
                                        <span class="text-xs opacity-70">${astroEngine.decimalToDMS(p.vargas[vargaKey || 'd1'].longitude)}</span>
                                    </div>
                                `).join('')}
                               </div>`
                            : `<div class="text-sm opacity-50 italic">No planets in this house</div>`
                        }
                    </div>
                    
                    <div class="divider"></div>
                    
                    <!-- Significations -->
                    <div>
                        <div class="text-xs uppercase font-bold opacity-60 mb-2">Key Significations</div>
                        <div class="flex flex-wrap gap-2">
                            ${bhava.significations.map(s => `<div class="badge badge-outline">${s}</div>`).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            backdrop.classList.remove('hidden');
        };
        
        window.closeBhavaModal = () => {
            document.getElementById('bhava-modal-backdrop').classList.add('hidden');
        };

        // --- ASPECT VISUALIZATION ---
        
        let showAspects = false;
        let aspectFilter = new Set(['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn', 'Rahu', 'Ketu']); // Default all
        
        window.toggleAspects = () => {
             showAspects = !showAspects;
             const btnText = document.getElementById('aspect-btn-text');
             if(btnText) btnText.innerText = showAspects ? "Hide Aspects" : "Show Aspects";
             
             // Toggle Filter Panels for BOTH D1 and D9 (or any others added later)
             const chartIds = ['d1', 'd9'];
             
             chartIds.forEach(chartId => {
                 const container = document.getElementById(`chart-container-${chartId}`);
                 if(!container) return;
                 
                 let filterPanel = document.getElementById(`aspect-filter-panel-${chartId}`);
                 
                 if(showAspects) {
                     if(!filterPanel) {
                         // Create Filter Panel
                         filterPanel = document.createElement('div');
                         filterPanel.id = `aspect-filter-panel-${chartId}`;
                         filterPanel.className = "mt-4 p-3 bg-base-200 rounded-xl grid grid-cols-5 gap-2 text-xs";
                         
                         const planets = ['Sun', 'Moon', 'Mars', 'Mer', 'Jup', 'Ven', 'Sat', 'Rah', 'Ket'];
                         const fullNames = ['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn', 'Rahu', 'Ketu'];
                         
                         filterPanel.innerHTML = fullNames.map((p, i) => `
                            <button onclick="toggleAspectFilter('${p}')" id="aspect-filter-${chartId}-${p}" class="btn btn-xs ${aspectFilter.has(p) ? 'btn-primary' : 'btn-ghost border-gray-400'}">
                                ${planets[i]}
                            </button>
                         `).join('');
                         
                         // Add "All/None" buttons
                         filterPanel.innerHTML += `
                            <button onclick="setAspectFilterAll(true)" class="btn btn-xs btn-outline col-span-2">All</button>
                            <button onclick="setAspectFilterAll(false)" class="btn btn-xs btn-outline col-span-3">Clear</button>
                         `;
                         
                         container.appendChild(filterPanel);
                     } else {
                         filterPanel.classList.remove('hidden');
                     }
                 } else {
                     if(filterPanel) filterPanel.classList.add('hidden');
                 }
             });

             if(showAspects) {
                 drawAspectLines();
                 window.addEventListener('resize', drawAspectLines);
                 
                 // If tabs switch, we need to redraw
                 const tabs = document.querySelectorAll('.tab');
                 tabs.forEach(t => t.addEventListener('click', () => setTimeout(drawAspectLines, 100)));
             } else {
                 chartIds.forEach(chartId => {
                     const svg = document.getElementById(`aspect-overlay-${chartId}`);
                     if(svg) svg.remove();
                 });
                 window.removeEventListener('resize', drawAspectLines);
             }
        };

        window.toggleAspectFilter = (p) => {
             const chartIds = ['d1', 'd9'];
             
             if(aspectFilter.has(p)) {
                 aspectFilter.delete(p);
                 chartIds.forEach(id => {
                     const btn = document.getElementById(`aspect-filter-${id}-${p}`);
                     if(btn) {
                         btn.classList.remove('btn-primary');
                         btn.classList.add('btn-ghost', 'border-gray-400');
                     }
                 });
             } else {
                 aspectFilter.add(p);
                 chartIds.forEach(id => {
                     const btn = document.getElementById(`aspect-filter-${id}-${p}`);
                     if(btn) {
                         btn.classList.add('btn-primary');
                         btn.classList.remove('btn-ghost', 'border-gray-400');
                     }
                 });
             }
             drawAspectLines();
        };

        window.setAspectFilterAll = (enable) => {
             const fullNames = ['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn', 'Rahu', 'Ketu'];
             if(enable) {
                 fullNames.forEach(p => aspectFilter.add(p));
             } else {
                 aspectFilter.clear();
             }
             
             const chartIds = ['d1', 'd9'];
             
             fullNames.forEach(p => {
                 chartIds.forEach(id => {
                     const btn = document.getElementById(`aspect-filter-${id}-${p}`);
                     if(btn) {
                         if(enable) {
                             btn.classList.add('btn-primary');
                             btn.classList.remove('btn-ghost', 'border-gray-400');
                         } else {
                             btn.classList.remove('btn-primary');
                             btn.classList.add('btn-ghost', 'border-gray-400');
                         }
                     }
                 });
             });
             drawAspectLines();
        };

        function drawAspectLines() {
            // Draw for ALL active charts
            const chartIds = ['d1', 'd9'];
            
            chartIds.forEach(chartId => {
                const container = document.getElementById(`chart-container-${chartId}`);
                if(!container || container.classList.contains('hidden')) return; // Only if container visible? Actually chart grid inside
                
                // Usually tabs toggle 'hidden' on the container.
                // Mobile: tabs switch visibility. Desktop: Maybe sticky?
                // Check if hidden relative to style
                if(container.offsetParent === null) return;
                
                const chartGrid = document.getElementById(`chart-${chartId}`);
                if(!chartGrid) return;

                // Remove existing SVG for THIS chart
                const existing = document.getElementById(`aspect-overlay-${chartId}`);
                if(existing) existing.remove();
                
                const rect = chartGrid.getBoundingClientRect();
                
                // Create SVG Layer
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.id = `aspect-overlay-${chartId}`;
                svg.setAttribute("width", "100%");
                svg.setAttribute("height", "100%");
                svg.style.position = "absolute";
                svg.style.top = "0";
                svg.style.left = "0";
                svg.style.pointerEvents = "none";
                svg.style.zIndex = "10";
                
                // Calculate centers
                const houseCenters = {};
                const cells = chartGrid.querySelectorAll('.chart-cell');
                
                const aspectsToDraw = [];
                
                cells.forEach(c => {
                     const hNum = parseInt(c.dataset.houseNum);
                     const cRect = c.getBoundingClientRect();
                     // Calculate center relative to chartGrid
                     houseCenters[hNum] = {
                         x: cRect.left + cRect.width/2 - rect.left,
                         y: cRect.top + cRect.height/2 - rect.top
                     };
                     
                     // Find planets
                     const glyphs = c.querySelectorAll('.planet-glyph');
                     glyphs.forEach(g => {
                         let pName = "";
                         if(g.classList.contains('planet-Mars')) pName="Mars";
                         else if(g.classList.contains('planet-Jupiter')) pName="Jupiter";
                         else if(g.classList.contains('planet-Saturn')) pName="Saturn";
                         else if(g.classList.contains('planet-Sun')) pName="Sun";
                         else if(g.classList.contains('planet-Moon')) pName="Moon";
                         else if(g.classList.contains('planet-Mercury')) pName="Mercury";
                         else if(g.classList.contains('planet-Venus')) pName="Venus";
                         else if(g.classList.contains('planet-Rahu')) pName="Rahu"; 
                         else if(g.classList.contains('planet-Ketu')) pName="Ketu";
                         
                         if(pName && aspectFilter.has(pName)) {
                             let aspects = [7];
                             if(pName === 'Mars') aspects = [4, 7, 8];
                             if(pName === 'Jupiter') aspects = [5, 7, 9];
                             if(pName === 'Saturn') aspects = [3, 7, 10];
                             if(pName === 'Rahu' || pName === 'Ketu') aspects = [5, 7, 9]; 
                             
                             aspectsToDraw.push({from: hNum, planet: pName, aspects: aspects});
                         }
                     });
                });
                
                aspectsToDraw.forEach(item => {
                    item.aspects.forEach(aspect => {
                         const targetHouse = ((item.from + aspect - 1) % 12) || 12; // 1-based wrapping
                         
                         const start = houseCenters[item.from];
                         const end = houseCenters[targetHouse];
                         
                         if(start && end) {
                             const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                             // Curvy line
                             const d = `M ${start.x} ${start.y} Q ${rect.width/2} ${rect.height/2} ${end.x} ${end.y}`;
                             
                             line.setAttribute("d", d);
                             line.setAttribute("stroke", getAspectColor(item.planet));
                             line.setAttribute("stroke-width", "2");
                             line.setAttribute("stroke-opacity", "0.4");
                             line.setAttribute("fill", "none");
                             
                             svg.appendChild(line);
                         }
                    });
                });
                
                chartGrid.appendChild(svg);
                // chartGrid needs relative positioning? It's a grid so usually static. 
                // We appended SVG to chartGrid. chartGrid needs position relative.
                const style = window.getComputedStyle(chartGrid);
                if(style.position === 'static') {
                    chartGrid.style.position = 'relative';
                }
            });
        }
        
        function getAspectColor(planet) {
            switch(planet) {
                case 'Mars': return '#ef4444'; // Red
                case 'Jupiter': return '#eab308'; // Yellow
                case 'Saturn': return '#3b82f6'; // Blue
                default: return '#10b981'; // Green generic
            }
        }

        // Initialize theme on page load
        (function initTheme() {
            const storedTheme = getStoredTheme();
            setTheme(storedTheme);
        })();
    </script>
</body>
</html>